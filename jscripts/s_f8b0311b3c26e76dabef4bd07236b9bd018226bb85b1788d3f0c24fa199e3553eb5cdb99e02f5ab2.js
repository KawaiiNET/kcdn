var Utils={};Utils.secondsToTime=function(a){var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),a=Math.floor(a-3600*b-60*c),d="";return 0!=b&&(d=b+":"),(0!=c||""!==d)&&(c=10>c&&""!==d?"0"+c:String(c),d+=c+":"),""===d?d=a+"s":d+=10>a?"0"+a:String(a),d},Utils.secondsToTimeUniform=function(a){var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60),a=Math.floor(a-3600*b-60*c),d="";return 0!=b&&(d=b+":"),c=10>c&&""!==d?"0"+c:String(c),d+=c+":",d+=10>a?"0"+a:String(a)},Utils.notify=function(a,b,c){c="undefined"!=typeof c?c:!1,"string"==typeof b&&b.length>0&&(b=[b]);for(var d=0;d<b.length;d++){var e=b[d];$.jnotify(e,{delay:2500,fadeSpeed:300,slideSpeedUp:500,slideSpeedDown:350,type:a,sticky:c,showClose:!0,closeLabel:"&times;"})}},Utils.checkListingBlocks=function(){$(".listing-block").each(function(){if($(this).hasClass("restricted")){var a=$(this).attr("id");$("#"+a+" .listing-content").height($("#"+a+" .card-group > div").height()-7),$("#"+a+" .collection-details").height($("#"+a+" .card-group > div").height()-7)}}),$(".listing-content").width($(".container").width())},Utils.checkRadioButtons=function(){$(".radio-input").each(function(){$(this).is(":checked")?$(this).parent().parent().addClass("checked"):$(this).parent().parent().removeClass("checked")})},Utils.redirectToLoginIfNoUser=function(){return null==AnimeApp.currentUser?($("#login-modal").modal("show"),!1):!0},Utils.showSubscribeModal=function(){$("#upgrade-subscription-modal").modal("show"),analytics&&analytics.page({path:"/subscriptions/upgrade-modal"})},Utils.showAdblockModal=function(){$("#adblock-modal").modal("show")},Utils.trackPageView=function(){analytics&&analytics.page({path:Backbone.history.getFragment()})},Utils.trackEvent=function(a,b,c){analytics&&analytics.track(b,{category:a,label:c})},Utils.DateDiff={inDays:function(a,b){var c=b.getTime(),d=a.getTime();return parseInt((c-d)/864e5)},inWeeks:function(a,b){var c=b.getTime(),d=a.getTime();return parseInt((c-d)/6048e5)},inMonths:function(a,b){var c=a.getFullYear(),d=b.getFullYear(),e=a.getMonth(),f=b.getMonth();return f+12*d-(e+12*c)},inYears:function(a,b){return b.getFullYear()-a.getFullYear()}},Utils.niceDateFromNow=function(a){var b=new Date,c=a.getTime()-b.getTime();if(6e4>=c)return Messages("js.nicedatefromnow.verysoon.message");if(36e5>=c){var d=parseInt(c/6e4);return Messages("js.nicedatefromnow.minute"+(1!=d?"s":""),d)}if(864e5>=c){var e=parseInt(c/36e5);return Messages("js.nicedatefromnow.hour"+(1!=e?"s":""),e)}var f=parseInt(c/864e5);return Messages("js.nicedatefromnow.day"+(1!=f?"s":""),f)},Utils.showListLoader=function(){$(".listing-loader").show()},Utils.closeListLoader=function(){$(".listing-loader").hide()},Utils.matureCheck=function(a){bootbox.dialog({title:Messages("mature.content.warning"),message:"<p>"+Messages("mature.content.message")+"</p><p><small>"+Messages("mature.content.sub.message")+"</small></p>",buttons:{cancel:{label:Messages("mature.content.cancel"),className:"btn btn-default"},ok:{label:Messages("mature.content.ok"),className:"btn btn-secondary",glyphicon:"glyphicon-ok_2",callback:function(){return $.ajax({url:"/api/account/mature",data:{mature:!0}}),a&&a(),!0}}}})},"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return-1!==this.indexOf(a,0)});var CoreModel=Backbone.Model.extend({sync:function(a,b,c){c=c||{};var d=b.url;switch(a){case"update":case"read":case"delete":d+="/"+b.id}return c.url=d,Backbone.sync(a,b,c)},toJSON:function(){var a=_.clone(this.attributes);for(var b in this.attributes){var c=this.attributes[b];c instanceof Backbone.Model?a[b+".id"]=c.get("id"):null!=c&&c.id&&(a[b+".id"]=c.id)}return a}}),Guest=CoreModel.extend({urlRoot:"api/guests",initialize:function(a){},isInRole:function(a){var b=this.get("roles");if(b){var c=_.find(b,function(b){return b.name===a});return c?!0:!1}},hasPermission:function(a,b){var c=this.get("permissions");if(c){var d=_.find(c,function(c){return"undefined"!=typeof b?c.value===a&&c.resourceId&&c.resourceId===b:c.value===a});if(d)return!0}return!1},permissionsForVideoEntry:function(a){var b={},c=a.hasSubbedVideo&&this.hasPermission(User.Permissions.WATCH_SUBBED),d=a.hasDubbedVideo&&this.hasPermission(User.Permissions.WATCH_DUBBED),e=a.isAvod&&this.hasPermission(User.Permissions.WATCH_AVOD)||a.isSvod&&this.hasPermission(User.Permissions.WATCH_SVOD);return b.canWatchSubbed=e&&c,b.canWatchDubbed=e&&d,b.canWatch=e&&(c||d),b}},{Roles:{USER:"user",SUBSCRIBER:"subscriber",STAFF:"staff"},Permissions:{WATCH_VIDEO_QUALITY:"watchVideoQuality",WATCH_NO_ADS:"watchNoAds",WATCH_AVOD:"watchAvod",WATCH_SVOD:"watchSvod",WATCH_SUBBED:"watchSubbed",WATCH_DUBBED:"watchDubbed",CAST_VIDEOS:"castVideos"}});Backbone.$.ajaxSetup({headers:{"x-animelab-client":"web"}}),Backbone.Marionette.TemplateCache.prototype.loadTemplate=function(a){return JST[a]},Backbone.Marionette.TemplateCache.prototype.compileTemplate=function(a){return a};var AnimeApp=new Backbone.Marionette.Application;AnimeApp.currentUser=null;var AppRouter=new Backbone.Marionette.AppRouter,pushState=!(!window.history||!window.history.pushState);Backbone.history.start({pushState:pushState});var ua=navigator.userAgent.toLowerCase(),isAndroid=ua.indexOf("android")>-1,isIpad=ua.indexOf("ipad")>-1,isIphone=ua.indexOf("iphone")>-1,isChrome=ua.indexOf("chrome")>-1,isWiiU=ua.indexOf("wiiu")>-1,isSafari=ua.indexOf("safari")>-1,isMobile=isAndroid||isIpad||isIphone||isWiiU,isIE=function(){var a=window.navigator.userAgent,b=a.indexOf("MSIE ");return b>0||navigator.userAgent.match(/Trident.*rv\:11\./)?!0:!1},deviceHasFlash=FlashDetect.installed;$(".has-popover").popover({animation:!0,trigger:"hover",delay:300}),$(".nav-tabs").tabCollapse({accordionClass:"visible-xs accordion-tabs"}),$("body").on("click",function(a){$('[data-toggle="popover"]').each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||$(this).popover("hide")})}),function(){if("-ms-user-select"in document.documentElement.style&&navigator.userAgent.match(/IEMobile\/10\.0/)){var a=document.createElement("style");a.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(a)}}(),$("#search-lab").focus(function(){searchWidthMaxWidth=$("#site-navigation").width()-($("#header-navigation").width()+$("#main-navigation").width()+$("#account-navigation").width()),searchWidthMaxWidth>$("#search-lab").width()&&$(window).width()>768?$("#search-lab").width(searchWidthMaxWidth):$("#search-lab").removeAttr("style")}),$("#search-lab").focusout(function(){$("#search-lab").removeAttr("style")}),$("#search-lab").autocomplete({serviceUrl:"/shows/autocomplete",paramName:"searchTerms",triggerSelectOnValidInput:!1,onSelect:function(a){$("#search-lab-form").submit()},width:300,onInvalidateSelection:function(){}}),$("body").hasClass("home")&&$("#site-navigation").addClass("home"),Utils.checkRadioButtons(),$(".radio-input").change(function(){Utils.checkRadioButtons()}),$(window).resize(function(){Utils.checkListingBlocks(),$("#search-lab").removeAttr("style")}),$("#login-modal").on("shown.bs.modal",function(){$("#modal-email").focus()}),$("#register-modal").on("shown.bs.modal",function(){$("#register-modal").find("input[name=name]").focus()}),Handlebars.registerHelper("LowerCase",function(a){return a?new Handlebars.SafeString(a.toLowerCase()):""}),Handlebars.registerHelper("Messages",function(a){return a?new Handlebars.SafeString(Messages(a)):""}),Handlebars.registerHelper("eq",function(a,b,c){return a===b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("ne",function(a,b,c){return a!=b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("ge",function(a,b,c){return a>=b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("gt",function(a,b,c){return a>b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("lt",function(a,b,c){return b>a?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("le",function(a,b,c){return b>=a?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("and",function(a,b,c){return a&&b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("or",function(a,b,c){return a||b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("andnot",function(a,b,c){return a&&!b?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("hasQuality",function(a,b,c){var d=!1;if(a)for(var e=0;e<a.length;e++)if(a[e].quality===b){d=!0;break}return d?c.fn(this):c.inverse(this)}),Handlebars.registerHelper("isDateInFuture",function(a){var b=new Date,c=null;if("number"==typeof a)c=a-b.getTime();else{var d=new Date(a);c=d.getTime()-b.getTime()}return c>0?options.fn(this):options.inverse(this)}),Handlebars.registerHelper("isDateInPast",function(a,b){var c=new Date,d=null;if("number"==typeof a)d=a-c.getTime();else{var e=new Date(a);d=e.getTime()-c.getTime()}return 0>=d?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("niceDateFromNow",function(a){var b=null;return b="number"==typeof a?new Date(a):a,Utils.niceDateFromNow(b)}),Handlebars.registerHelper("canViewQuality",function(a,b){return AnimeApp.currentUser&&AnimeApp.currentUser.hasPermission(User.Permissions.WATCH_VIDEO_QUALITY,a)?b.fn(this):b.inverse(this)});var GenreRouter=Backbone.Marionette.AppRouter.extend({appRoutes:{"genres/:slug":"browseGenrePage"}}),GenreCardItemView=Backbone.Marionette.Layout.extend({template:"genreCard",onRender:function(){this.setElement(this.$el=this.$el.children().unwrap())}}),CardCollectionAnimator=function(a,b){a.isAnimating=!0,a.onShow=_.wrap(a.onShow,function(b){b&&b(),a.animateCards()}),a.animateCards=function(){for(var c=$(a.el).find(".card").addBack(".card").toArray(),d=0;d<c.length;d++){var e=c[d],f=(d+1)*(b?b:25);$(e).hasClass("start-state")&&($(e).delay(f).queued("removeClass","start-state"),d>=c.length-1&&setTimeout(function(){d>=c.length-1&&(a.isAnimating=!1)},f))}},a.onAfterItemAdded=_.wrap(a.onAfterItemAdded,function(b,c){b&&b();var d=$(c.el).find(".card").addBack(".card");a.isAnimating?a.animateCards():$(d).removeClass("start-state")})},Loader=function(a){this.xhr=null,this.progress=null,"undefined"==typeof a?this.loaderView=function(){this.before=function(){},this.after=function(){}}:this.loaderView=a,this.load=function(a){return this.loaderView.before.apply(this.loaderView),this.xhr=$.when.apply(this,arguments),null!=this.progress&&this.xhr.progress(this.progress),this},this.done=function(){var a=this;return this.xhr=this.xhr.done(function(){a.loaderView.after()}).done.apply(this,arguments),this}},ListLoader=function(){this.before=function(){Utils.showListLoader()},this.after=function(){Utils.closeListLoader()},this.progress=function(a){}},InfiniteScroll=function(a){a.onScroll=_.wrap(a.onScroll,function(b,c){b&&b.call(a,c);var d=this.$el.parent().parent();if(d.hasClass("listing-content")||(d=this.$el),!(0==d.height()&&this.collection.length>0)){var e=d.height()+d.offset().top,f=$(window).scrollTop()+$(window).height(),g=0;f-g>=e&&this.checkMoreContent()}}),a.checkMoreContent=function(){if(this.collection.hasNextPage()&&!this.loading){this.loading=!0;var b=this;new Loader(new ListLoader).load(this.collection.next()).done(function(){b.loading=!1,a.checkNoScroll(),a.onLoadedMoreContent()})}},a.onLoadedMoreContent=_.wrap(a.onLoadedMoreContent,function(b){b&&b.call(a)}),a.onClose=_.wrap(a.onClose,function(b){b&&b.call(a),$(window).off("scroll")}),a.onShow=_.wrap(a.onShow,function(b){b&&b.call(a),setTimeout(function(){a.checkNoScroll()},200)}),a.checkNoScroll=function(){var b=$("body").height()-($(".footer").height()+parseInt($(".footer").css("paddingTop")||0)+parseInt($(".footer").css("paddingBottom")||0)),c=$(window).height();c>=b&&a.checkMoreContent()},$(window).on("resize",_.bind(a.onScroll,a)),$(window).on("scroll",_.bind(a.onScroll,a))},GenreCardCollectionView=Backbone.Marionette.CollectionView.extend({itemView:GenreCardItemView,initialize:function(a){new InfiniteScroll(this),new CardCollectionAnimator(this)},_initialEvents:function(){this.collection&&this.listenTo(this.collection,"add",this.addChildView,this)}}),FollowShowView=Backbone.Marionette.ItemView.extend({template:"followWidget",events:{"click .action-follow-show":"followShow","click .action-unfollow-show":"unfollowShow"},initialize:function(a){a.parent&&(this.parent=a.parent)},followShow:function(a){if(!Utils.redirectToLoginIfNoUser())return!1;var b=this;return this.model.get("loading")||(this.model.set("loading",!0),$.when(this.model.save()).done(function(a){b.model.unset("loading"),Utils.notify("success",Messages("js.followshowview.addedtomyshows",b.model.get("showName"))),Utils.trackEvent("Shows","Show Followed",b.parent.model.get("slug")),b.parent.showFollowed(b.model)})),!1},unfollowShow:function(a){if(!Utils.redirectToLoginIfNoUser())return!1;var b=this;return this.model.get("loading")||(this.model.set("loading",!0),$.when(this.model.destroy()).done(function(){b.model.unset("id"),b.model.unset("loading"),Utils.notify("success",Messages("js.followshowview.removedfrommyshows",b.model.get("showName"))),Utils.trackEvent("Shows","Show Unfollowed",b.parent.model.get("slug")),b.parent.showUnfollowed(b.model)})),!1},reRender:function(){this.render()}}),ShowCardItemView=Backbone.Marionette.Layout.extend({template:"showCard",userShow:null,regions:{followWidget:".follow-widget"},initialize:function(a){null!=AnimeApp.currentUser&&this.model.set("currentUser",AnimeApp.currentUser),this.model.get("meanRating")>0&&this.model.set("rated",!0),AnimeApp.vent.on("show:followed",_.bind(this.onShowFollowed,this)),AnimeApp.vent.on("show:unfollowed",_.bind(this.onShowUnfollowed,this))},onRender:function(){this.setElement(this.$el=this.$el.children().unwrap())},onShow:function(){var a=this.getUserShow(),b=this;a.set("showName",this.model.get("name"));var c=new FollowShowView({model:a,template:"showCardFollowWidget",parent:b});this.followWidget.show(c)},showFollowed:function(a){this.model.set("userShow",a.toJSON()),AnimeApp.vent.trigger("show:followed",this.model)},showUnfollowed:function(a){this.model.set("userShow",a.toJSON()),AnimeApp.vent.trigger("show:unfollowed",this.model)},onShowFollowed:function(a){this.updateFollowWidget(a)},onShowUnfollowed:function(a){this.updateFollowWidget(a)},updateFollowWidget:function(a){if(a.get("id")==this.model.get("id")){this.model=a;var b=this.getUserShow();"undefined"!=typeof this.followWidget&&(this.followWidget.currentView.model=b,this.followWidget.currentView.render())}},getUserShow:function(){var a,b=this.model.get("id");return a=new UserShow(this.model.get("userShow")?this.model.get("userShow"):{showId:b,following:!1})}}),SpaceMakerView=Backbone.Marionette.ItemView.extend({template:"spaceMaker",className:"space-maker",initialize:function(a){a&&a.width?this.width=a.width:this.width=$(".card").getWidthInPercent()+"%"},onRender:function(){$(this.el).css("width",this.width)}}),EmptyResultsView=Backbone.Marionette.ItemView.extend({template:"emptyResults"}),MyShowsEmptyView=Backbone.Marionette.ItemView.extend({template:"myShowsEmpty"}),ShowCardCollectionView=Backbone.Marionette.CollectionView.extend({itemView:ShowCardItemView,loading:!1,initialize:function(a){a.myShows&&1==a.myShows&&(this.myShows=a.myShows,AnimeApp.vent.on("show:followed",_.bind(this.showFollowed,this)),AnimeApp.vent.on("show:unfollowed",_.bind(this.showUnfollowed,this))),a.infiniteScroll?this.infiniteScroll=a.infiniteScroll:this.infiniteScroll=!1,this.infiniteScroll&&new InfiniteScroll(this),new CardCollectionAnimator(this)},_initialEvents:function(){this.collection&&(this.infiniteScroll&&this.listenTo(this.collection,"add",this.addChildView,this),this.listenTo(this.collection,"remove",this.removeItemView,this),this.listenTo(this.collection,"reset",this.render,this))},itemViewOptions:function(a,b){return{index:b}},getEmptyView:function(){return this.myShows?MyShowsEmptyView:EmptyResultsView},onClose:function(){$(window).off("resize")},onShow:function(){},showFollowed:function(a){var b=this,c=new SpaceMakerView({width:"0%"});$(this.el).prepend(c.render().el),$(this.el).find(".space-maker").delay(30).animate({width:"20%"},400,function(){b.prependCard(a)})},showUnfollowed:function(a){$(this.el).parent().height($(this.el).parent().height()),$(this.el).fadeTo("slow",0,_.bind(this.refreshMyShows,this))},refreshMyShows:function(){var a=this,b=new SpaceMakerView({width:"0%"});$(a.el).find(".card").addBack(".card").each(function(a){$(b.el).height($(this).height()),$(this).replaceWith(b.render().el)}),$(this.el).find(".space-maker").delay(30).animate({width:"20%"},400,function(){});var c=$(window).scrollTop()+$(window).height();$.when(this.collection.fetch({data:{userId:AnimeApp.currentUser.get("id")}})).done(function(){var b=function(){$.when(a.collection.next()).done(d)},d=function(){return $(a.el).find(".space-maker").remove(),$(a.el).find(".card.start-state").each(function(a){$(this).removeClass("start-state")}),a.$el.height()+a.$el.offset().top<c&&a.collection.hasNextPage()?void b():($(a.el).fadeTo("slow",1),a.collection.size()>0&&a.myShows&&$("#my-shows-container").fadeIn(),void $(a.el).parent().height(""))};d()})},prependCard:function(a){this.closeEmptyView();var b=new ShowCardItemView({model:a});b.render(),b.onShow(),$(this.el).find(".space-maker").replaceWith(b.el),setTimeout(function(){$(b.el).find(".start-state").removeClass("start-state")},450),this.addChildViewEventForwarding(b),this.collection.unshift(a),this.myShows&&!$("#my-shows-container").is(":visible")&&$("#my-shows-container").fadeIn()}}),GenreController=Marionette.Controller.extend({browseGenres:function(a){var b=new GenreCardCollectionView({collection:a,infiniteScroll:!0});AnimeApp.genres.show(b)},genrePage:function(a,b,c){b&&AnimeApp.latestShows.show(b),c&&AnimeApp.allShows.show(c)}}),Genre=CoreModel.extend({urlRoot:"api/genres",initialize:function(a){}}),CoreCollection=Backbone.Collection.extend({page:0,totalPages:0,totalRows:0,limit:0,orderBy:null,params:null,url:null,lastOptions:{},fetch:function(a){return"undefined"==typeof a&&(a={}),this.limit&&(a.data=_.extend({},{limit:this.limit},a.data)),this.lastOptions=a,Backbone.Collection.prototype.fetch.call(this,a)},constructor:function(a,b){var c=null;a&&(c=this.initPage(a),0==a.infiniteScroll&&(this.limit=-1),(!c||c==a&&0==c.length)&&a.params&&this.load(a.params)),Backbone.Collection.apply(this,[],b),this.reset(c)},parse:function(a){return this.initPage(a)},initPage:function(a){return a.data&&(a=a.data),null!=a.pageIndex&&(this.page=a.pageIndex),null!=a.totalPageCount&&(this.totalPages=a.totalPageCount),null!=a.totalRowCount&&(this.totalRows=a.totalRowCount),null!=a.limit&&(this.limit=a.limit),null!=a.url&&(this.url=a.url),null!=a.orderBy&&(this.orderBy=a.orderBy),null!=a.params&&(this.params=a.params),a.list?a.list:a},next:function(){return this.hasNextPage()?(this.params.data||(this.lastOptions.data=this.params),this.lastOptions.data.page=this.page+1,this.lastOptions.update=!0,this.lastOptions.remove=!1,this.fetch(this.lastOptions)):void 0},prev:function(){return this.hasPrevPage()?(this.lastOptions.data||(this.lastOptions.data=this.params),this.lastOptions.data.page=this.page-1,this.lastOptions.update=!0,this.lastOptions.remove=!1,this.fetch(this.lastOptions)):void 0},hasNextPage:function(){return this.page<this.totalPages?!0:!1},hasPrevPage:function(){return this.page>0?!0:!1},gotoPage:function(a,b){return a<=this.totalPages&&a>0?this.load({page:a}):void 0},search:function(a){return this.load({search:a,page:1})},sort:function(a){return this.load({orderBy:a,page:1})},load:function(a,b){var c=this;return c.trigger("ajax:start"),b&&(c.params={}),$.ajax(this.url,{data:$.extend(c.params,{limit:c.limit},a),success:function(a){var b=c.initPage(a);c.reset(b),c.trigger("ajax:stop")},error:function(){c.trigger("ajax:stop")}})},reload:function(a){var b=new this.constructor;b.url=this.url,b.params=_.clone(this.lastOptions.data),b.params&&(b.params.page=0);var c={success:_.bind(function(b){b.hasNextPage()&&b.page<this.page?b.next(c):(this.page=b.page,this.totalPages=b.totalPages,this.totalRows=b.totalRows,this.reset(b.models),b.dispose(),a&&setTimeout(_.bind(function(){a(this)},this)))},this),error:_.bind(function(b){this.page=b.page,this.totalPages=b.totalPages,this.totalRows=b.totalRows,this.reset(b.models),b.dispose(),a&&setTimeout(_.bind(function(){a(this)},this))},this),collection:this,data:b.params};b.fetch(c)}}),Show=CoreModel.extend({urlRoot:"api/shows",initialize:function(a){}}),ShowCollection=CoreCollection.extend({url:"/api/shows",model:function(a,b){return new Show(a,b)}}),PlaylistVideoEntry=CoreModel.extend({url:"/api/playlistvideoentries",initialize:function(a){}}),Playlist=CoreModel.extend({url:"/api/playlists",initialize:function(a){}},{TYPE_SMART_PLAYLIST:"SMART PLAYLIST"}),HEARTBEAT_TIMEOUT=3e4,DEVICE_STATE={IDLE:"IDLE",ACTIVE:"ACTIVE",WARNING:"WARNING",ERROR:"ERROR"},PLAYER_STATE={IDLE:"IDLE",LOADING:"LOADING",LOADED:"LOADED",PLAYING:"PLAYING",PAUSED:"PAUSED",STOPPED:"STOPPED",SEEKING:"SEEKING",ERROR:"ERROR"},BITRATES={MEDIUM_QUALITY:500,HIGH_QUALITY:1200},ADVERT_STATE={NONE:0,PREROLL:1,MIDROLL:2,ENDROLL:3},AD_COMPANION_ZONE=62745,STYLED_RECEIVER_APP_ID="53C25447",SUBSCRIBE_URL="/subscribe-content",SmartPlaylistWidget=Backbone.Marionette.ItemView.extend({template:"smartPlaylistWidget",mature:!1,events:{"click .action-add-smart-playlist":"matureCheck","click .action-remove-smart-playlist":"removeFromSmartPlaylist"},onShow:function(){$(".has-tooltip").tooltip({container:"body"})},initialize:function(a){this.model.on("change",this.reRender(),this),a.parent&&(this.parent=a.parent),a.mature&&(this.mature=a.mature),a.click&&(this.click=a.click),this.permissions=a.permissions},matureCheck:function(a){if(this.click&&a&&this.click(a),!Utils.redirectToLoginIfNoUser())return!1;if(!this.permissions.canWatch)return Utils.showSubscribeModal(),!1;if(this.mature&&!AnimeApp.currentUser.get("mature")){var b=this;Utils.matureCheck(function(){b.addToSmartPlaylist()})}else this.addToSmartPlaylist(a);return!1},addToSmartPlaylist:function(a){if(this.click&&a&&this.click(a),!this.permissions.canWatch)return Utils.showSubscribeModal(),!1;if(!Utils.redirectToLoginIfNoUser())return!1;var b=this;b.model.set("loading",!0),b.reRender(),$.when(this.model.save()).done(function(a){b.model.unset("loading"),Utils.notify("success",Messages("js.smartplaylistwidget.addedtoqueue",b.model.get("episodeName"))),Utils.trackEvent("Episodes","Episode Queued",b.model.get("slug")),b.reRender(),b.addTooltip()})},removeFromSmartPlaylist:function(a){if(this.click&&a&&this.click(a),!Utils.redirectToLoginIfNoUser())return!1;var b=this;b.model.set("loading",!0),b.reRender();var c=b.model.get("episodeName"),d=b.model.get("slug");return"undefined"==typeof c&&(c=b.parent.model.get("name")),"undefined"==typeof d&&(d=b.parent.model.get("slug")),$.when(this.model.destroy()).done(function(){b.model.unset("id"),b.model.unset("loading"),Utils.notify("success",Messages("js.smartplaylistwidget.removedfromqueue",c)),Utils.trackEvent("Episodes","Episode Unqueued",d),b.reRender(),b.parent&&b.parent.removedFromPlaylist&&b.parent.removedFromPlaylist(b.model),b.addTooltip()}),!1},reRender:function(){$(this.el).find(".has-tooltip").tooltip("destroy"),this.render()},addTooltip:function(){$(this.el).find(".has-tooltip").tooltip({container:"body"})}}),EpisodeSynopsisModalView=Backbone.Marionette.ItemView.extend({template:"episodeSynopsisModal",className:"modal-content",events:{"click .action-watch-instantly":"watchVideo"},initialize:function(a){a.hideShowDetails&&this.model.set("hideShowDetails",!0),this.permissions=a.permissions},serializeData:function(){return{videoEntry:this.model.toJSON(),permissions:this.permissions}},watchVideo:function(a){if(this.permissions.canWatch){var b=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",b);var c="/player/"+this.model.get("slug");window.location.href=c}return!1}}),EpisodeCardItemView=Backbone.Marionette.Layout.extend({template:"episodeCard",regions:{smartPlaylistWidget:"#add-smart-playlist-container"},events:{"click .action-episode-synopsis":"showEpisodeSynopsisModal","click .action-play-vid":"playVideo"},className:function(){return this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.toJSON()):{},this.permissions.canWatch?this.model.get("playbackPosition")&&1==this.model.get("playbackPosition").complete?"watched":null:"premium"},serializeData:function(){return{videoEntry:this.model.toJSON(),permissions:this.permissions}},initialize:function(a){this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.toJSON()):{}},onShow:function(){var a,b=this,c=this.model.get("id");a=new PlaylistVideoEntry(this.model.get("smartPlaylistVideoEntry")?this.model.get("smartPlaylistVideoEntry"):{videoEntryId:c,following:!1}),a.set("type",Playlist.TYPE_SMART_PLAYLIST),a.set("episodeName",this.model.get("name")),a.set("slug",this.model.get("slug"));var d=new SmartPlaylistWidget({model:a,mature:this.model.get("mature"),template:"episodeCardSmartPlaylistWidget",parent:b,permissions:this.permissions});this.smartPlaylistWidget.show(d)},onRender:function(){this.setElement(this.$el=this.$el.children().unwrap())},showEpisodeSynopsisModal:function(a){var b=new EpisodeSynopsisModalView({model:this.model});AnimeApp.episodeModal.show(b);var c=this.model.get("slug");return Utils.trackEvent("Episodes","Episode Info Opened",c),$("#episode-synopsis-modal").modal("show"),!1},playVideo:function(a){var b=!1;if(this.permissions.canWatch||null==AnimeApp.currentUser){var c=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/"+this.model.get("slug")}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1}}),EpisodeCardCollectionView=Backbone.Marionette.CollectionView.extend({itemView:EpisodeCardItemView,initialize:function(a){a&&a.infiniteScroll&&new InfiniteScroll(this),new CardCollectionAnimator(this)}}),Carousel=function(a){a.carouselIndex=0,a.events=_.extend({},a.events,{"click .next":"next","click .prev":"prev"}),a.initCarousel=function(){var a=$(this.el).find(".listing-content"),b=this.visibleCards(),c=$(a).width()/b;$(this.el).find(".card").width(c),$(this.el).find(".card-group").css({width:this.collection.length*c,"margin-left":this.carouselIndex*c*-1+"px"}),this.initCarouselControls()},a.bind("dom:refresh",function(){a.initCarousel()}),a.next=function(){var a=this.visibleCards(),b=$(this.el).find(".card").width();return this.carouselIndex+a<this.collection.length&&(this.carouselIndex=this.carouselIndex+a,$(this.el).find(".card-group").css({"margin-left":b*this.carouselIndex*-1+"px"})),this.initCarouselControls(),!1},a.prev=function(){var a=this.visibleCards(),b=$(this.el).find(".card").width();return this.carouselIndex>0&&(this.carouselIndex=this.carouselIndex-a,$(this.el).find(".card-group").css({"margin-left":b*this.carouselIndex*-1+"px"})),this.initCarouselControls(),!1},a.initCarouselControls=function(){var a=this.visibleCards();this.carouselIndex<=0?$(this.el).find(".prev").addClass("disabled"):this.carouselIndex>0&&$(this.el).find(".prev").removeClass("disabled"),this.carouselIndex<this.collection.length-a?$(this.el).find(".next").removeClass("disabled"):$(this.el).find(".next").addClass("disabled")},a.visibleCards=function(){var a=$(window).width();return 480>a?2:a>=480&&768>a?3:a>=768&&992>a?3:a>=992&&1200>a?4:a>=1200?5:void 0},a.bind("after:item:added",function(){a.initCarousel()}),a.bind("item:removed",function(){a.initCarousel()}),a.onClose=_.wrap(a.onClose,function(a){a&&a(),$(window).off("resize")}),$(window).on("resize",_.bind(a.initCarousel,a))},CollectionContainerView=Backbone.Marionette.Layout.extend({options:null,template:"collectionContainer",collectionView:null,regions:{cardGroup:".card-group"},initialize:function(a){this.options=a;var b={collection:this.collection,myShows:this.options.myShows,infiniteScroll:this.options.infiniteScroll};"episode"==this.options.type?this.collectionView=new EpisodeCardCollectionView(b):"genre"==this.options.type?this.collectionView=new GenreCardCollectionView(b):this.collectionView=new ShowCardCollectionView(b);a.carousel&&(/(iPhone|iPod|iPad)/g.test(navigator.userAgent)?this.options.carousel=!1:new Carousel(this))},onRender:function(){this.setElement(this.$el=this.$el.children().unwrap()),this.cardGroup.show(this.collectionView)},onDomRefresh:function(){$(this.el).parent().addClass("collection-container")},serializeData:function(){return this.options}}),ChromeCastWidget=Backbone.Marionette.ItemView.extend({template:"episodeCastWidget",events:{"click .action-cast-start":"startCasting","click .action-cast-end":"endCasting"},initialize:function(a){a.click&&(this.click=a.click),a.url&&(this.url=a.url),this.permissions=a.permissions,this.model=this.model?this.model:new Backbone.Model,a.videoEntry&&this.model.set("videoEntry",a.videoEntry.toJSON()),AnimeApp.vent.on("chromeCast:receiverAvailability",_.bind(this.render,this)),AnimeApp.vent.on("chromeCast:endSession",_.bind(this.render,this)),AnimeApp.vent.on("chromeCast:session",_.bind(this.render,this)),AnimeApp.vent.on("chromeCast:sessionUpdate",_.bind(this.render,this)),ChromebarView.cast&&this.model.set("cast",ChromebarView.cast)},startCasting:function(a){if(this.click&&a&&this.click(a),!this.permissions.canWatch)return Utils.showSubscribeModal(),!1;if(!Utils.redirectToLoginIfNoUser())return!1;if(ChromebarView.cast.session)this.onRequestSessionSuccess(ChromebarView.cast.session);else{var b=this,c=function(a){b.onRequestSessionSuccess.call(b,a)};chrome.cast.requestSession(c,function(){})}return!1},endCasting:function(a){return this.click&&a&&this.click(a),Utils.redirectToLoginIfNoUser()?(ChromebarView.cast.session&&ChromebarView.cast.session.stop(),!1):!1},onRequestSessionSuccess:function(a){window.location=this.url}}),SeasonHeaderView=Backbone.Marionette.Layout.extend({template:"seasonListItemHeader",className:"custom-message season-split",tagName:"li"}),EpisodeListItemView=Backbone.Marionette.Layout.extend({template:"episodeListItem",tagName:"li",newSeason:!1,regions:{smartPlaylistWidget:"#add-smart-playlist-container",chromeCastWidget:"#chrome-cast-container"},events:{"click .action-episode-synopsis":"showEpisodeSynopsisModal","click .action-mark-watched":"toggleWatched","click .button-watch-subbed":"watchSubbedVideo","click .button-watch-dubbed":"watchDubbedVideo","click .dropdown-menu a":"hideDropdown","click .action-play-episode":"playEpisode"},playlistVideoEntry:null,popover:!1,initialize:function(a){a.subtitles&&this.model.set("subtitles",a.subtitles),a.newSeason&&(this.newSeason=a.newSeason),this.model.initCalculatedFields()},className:function(){return this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.toJSON()):{},this.permissions.canWatch?this.model.get("playbackPosition")&&1==this.model.get("playbackPosition").complete?"watched":null:"premium"},serializeData:function(){return{videoEntry:this.model.toJSON(),permissions:this.permissions}},onShow:function(){if(this.newSeason){var a=new Backbone.Model(this.model.get("season")),b=new SeasonHeaderView({model:a});b.render();$(this.el).before($(b.render().el).html())}var c,d=this.model.get("id");c=new PlaylistVideoEntry(this.model.get("smartPlaylistVideoEntry")?this.model.get("smartPlaylistVideoEntry"):{videoEntryId:d,following:!1}),c.set("type",Playlist.TYPE_SMART_PLAYLIST),c.set("episodeName",this.model.get("name")),c.set("slug",this.model.get("slug")),this.playlistVideoEntry=c;var e=new SmartPlaylistWidget({model:c,mature:this.model.get("mature"),click:this.hideDropdown,permissions:this.permissions});this.smartPlaylistWidget.show(e);var f=new ChromeCastWidget({videoEntry:this.model,url:"/player/"+this.model.get("slug"),click:this.hideDropdown,permissions:this.permissions
});this.chromeCastWidget.show(f)},showEpisodeSynopsisModal:function(a){var b=new EpisodeSynopsisModalView({model:this.model,hideShowDetails:!0,permissions:this.permissions});AnimeApp.episodeModal.show(b);var c=this.model.get("slug");return Utils.trackEvent("Episodes","Episode Info Opened",c),$("#episode-synopsis-modal").modal("show"),!1},toggleWatched:function(a){if(!Utils.redirectToLoginIfNoUser())return!1;var b;b=this.model.get("playbackPosition")?new PlaybackPosition(this.model.get("playbackPosition")):new PlaybackPosition;var c=$(a.target).closest("a.action-mark-watched").hasClass("watched");c&&(b.set({videoEntryId:this.model.get("id"),complete:c,position:0}),b.unset("percentageWatched"),b.unset("positionInMinutes"));var d=this,e=function(){if(d.model.set("playbackPosition",c?b.toJSON():null),c){d.$el.addClass("watched");var a=d.model.get("slug");Utils.trackEvent("Episodes","Episode Marked Watched",a)}else{d.$el.removeClass("watched");var a=d.model.get("slug");Utils.trackEvent("Episodes","Episode Marked Unwatched",a)}d.render();var e=new SmartPlaylistWidget({model:d.playlistVideoEntry,mature:d.model.get("mature"),click:d.hideDropdown,permissions:d.permissions});d.smartPlaylistWidget.show(e),d.chromeCastWidget.show(new ChromeCastWidget({videoEntry:d.model,url:"/player/"+d.model.get("slug"),click:d.hideDropdown}))};try{$.when(c?b.save():b.destroy()).done(function(){e()})}catch(f){console.log(f),e()}return!1},watchSubbedVideo:function(a){var b=!1;if(this.model.get("hasSubbedVideo"))if(this.permissions.canWatchSubbed){var c=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/"+this.model.get("slug")+"/subtitles"}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1},watchDubbedVideo:function(a){var b=!1;if(this.model.get("hasDubbedVideo"))if(this.permissions.canWatchDubbed){var c=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/"+this.model.get("slug")+"/dubbed"}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1},hideDropdown:function(a){a&&$(a.target).closest(".options").removeClass("open")},playEpisode:function(a){var b=!1;if(this.permissions.canWatch){var c=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/"+this.model.get("slug")}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1}}),EpisodeListingView=Backbone.Marionette.CollectionView.extend({itemView:EpisodeListItemView,initialize:function(a){this.subtitles=a.subtitles,a&&a.infiniteScroll&&new InfiniteScroll(this)},itemViewOptions:function(a,b){return{subtitles:this.subtitles}}}),UserShow=CoreModel.extend({url:"/api/usershows",initialize:function(a){}}),UserShowRating=CoreModel.extend({url:"/api/usershowratings",initialize:function(a){}}),AddShowToQueueView=Backbone.Marionette.ItemView.extend({template:"addShowToQueueWidget",events:{"click .action-add-show-to-queue":"matureCheck"},initialize:function(a){a.parent&&(this.parent=a.parent)},matureCheck:function(a){if(this.model.get("mature")&&!AnimeApp.currentUser.get("mature")){var b=this;Utils.matureCheck(function(){b.addShowToQueue()})}else this.addShowToQueue(a)},addShowToQueue:function(a){if(!Utils.redirectToLoginIfNoUser())return!1;var b=this;return this.model.set("loading",!0),$.when($.ajax({type:"POST",url:"/api/playlistvideoentries/show",data:{showId:b.model.get("id"),type:"SMART PLAYLIST"}})).done(function(a){b.model.unset("loading"),Utils.notify("success",Messages("js.addshowtoqueueview.added",b.model.get("name"))),Utils.trackEvent("Shows","Show Queued",b.model.get("slug"))}),!1},reRender:function(){this.render()}}),MarkShowWatchedWidget=Backbone.Marionette.ItemView.extend({template:"markShowWatchedWidget",events:{"click .action-mark-show-watched":"markShowWatched"},initialize:function(a){a.parent&&(this.parent=a.parent)},markShowWatched:function(a){if(!Utils.redirectToLoginIfNoUser())return!1;var b=this;return this.model.set("loading",!0),$.when($.ajax({type:"GET",url:"/api/videoentries/show/"+b.model.get("id")+"/watched",data:{watched:!0}})).done(function(a){b.model.unset("loading"),Utils.notify("success",Messages("js.episodesofshowwatched.watched",b.model.get("name"))),Utils.trackEvent("Shows","Show Marked Watched",b.model.get("slug")),AnimeApp.vent.trigger("show:markedWatched",this.model)}),!1},reRender:function(){this.render()}}),StarRatingWidget=Backbone.Marionette.ItemView.extend({template:"starRatingWidget",events:{"click .rating":"onClick"},initialize:function(a){this.showSlug=a.showSlug},onShow:function(){this.ratingEl=$(this.el).find(".rating"),this.ratingEl.on("mousemove",_.bind(this.onHover,this)),this.ratingEl.on("mouseleave",_.bind(this.onMouseleave,this))},onClose:function(){this.ratingEl.off("mousemove")},onClick:function(a){if(!Utils.redirectToLoginIfNoUser())return!1;var b=a.pageX-this.ratingEl.offset().left,c=(a.pageY-this.ratingEl.offset().top,this.ratingEl.width()),d=b/c*100;d=10*Math.round(d/10),$(this.el).find(".rating-stars").css({width:d+"%"}),this.model.set("rating",d);var e=this;return $.when(this.model.save()).done(function(){Utils.notify("success",Messages("js.starratingwidget.ratingaddedfor",e.model.get("showName"))),Utils.trackEvent("Shows","Show Rated",e.showSlug)}),!1},onHover:function(a){var b=a.pageX-this.ratingEl.offset().left,c=(a.pageY-this.ratingEl.offset().top,this.ratingEl.width()),d=b/c*100;d=10*Math.round(d/10),$(this.el).find(".rating-stars").css({width:d+"%"})},onMouseleave:function(a){$(this.el).find(".rating-stars").css({width:this.model.get("rating")})}}),CommunityRatingView=Backbone.Marionette.ItemView.extend({template:"communityRating",initialize:function(a){this.model=new Backbone.Model,this.model.set("rating",a.rating),this.model.get("rating")>0?(this.model.set("title_attr","Community Rating "+this.model.get("rating")+"%"),this.model.set("rated",!0)):(this.model.set("title_attr","Not Yet Rated"),this.model.set("rated",!1))}}),RatingsBreakdownWidget=Backbone.Marionette.ItemView.extend({template:"ratingsBreakdown",initialize:function(a){this.model=new Backbone.Model,this.model.set("ratingsBreakdownItems",a.ratingsBreakdownItems)}}),ShowUserControlsView=Backbone.Marionette.Layout.extend({template:"userControls",regions:{followWidget:"#follow-show-container",addShowToQueueWidget:"#add-show-to-queue-container",markShowWatchedWidget:"#mark-show-watched-container",ratingsWidget:"#ratings-container",communityRating:"#community-ratings-container",ratingBreakdownWidget:"#ratings-breakdown-container"},initialize:function(a){AnimeApp.vent.on("show:followed",_.bind(this.onShowFollowed,this)),AnimeApp.vent.on("show:unfollowed",_.bind(this.onShowUnfollowed,this))},onShow:function(){var a=this.getUserShow();a.set("showName",this.model.get("name"));var b=new FollowShowView({model:a,parent:this});this.followWidget.show(b);var c=new AddShowToQueueView({model:this.model,parent:this});this.addShowToQueueWidget.show(c);var d=this.getUserShowRating();d.set("showName",this.model.get("name"));var e=new StarRatingWidget({model:d,showSlug:this.model.get("slug")}),f=new CommunityRatingView({rating:this.model.get("meanRating")});this.ratingsWidget.show(e),this.communityRating.show(f);var g=this.model.get("ratingsBreakdownItems");if(g&&g.length>0){var h=new RatingsBreakdownWidget({ratingsBreakdownItems:g});this.ratingBreakdownWidget.show(h)}},showFollowed:function(a){this.model.set("userShow",a.toJSON()),AnimeApp.vent.trigger("show:followed",this.model)},showUnfollowed:function(a){this.model.set("userShow",a.toJSON()),AnimeApp.vent.trigger("show:unfollowed",this.model)},onShowFollowed:function(a){this.updateFollowWidget(a)},onShowUnfollowed:function(a){this.updateFollowWidget(a)},updateFollowWidget:function(a){if(a.get("id")==this.model.get("id")){this.model=a;var b=this.getUserShow();"undefined"!=typeof this.followWidget&&(this.followWidget.currentView.model=b,this.followWidget.currentView.render())}},getUserShowRating:function(){var a,b=this.model.get("id");return a=new UserShowRating(this.model.get("userShowRating")?this.model.get("userShowRating"):{showId:b,rating:0})},getUserShow:function(){var a,b=this.model.get("id");return a=new UserShow(this.model.get("userShow")?this.model.get("userShow"):{showId:b,following:!1})}}),ShowController=Marionette.Controller.extend({showPage:function(a,b,c){_.each(b,function(a,b){var d=new EpisodeListingView({collection:a,infiniteScroll:!0,subtitles:c}),e=AnimeApp["season"+a.params.seasonId];e&&e.show(d)}),$("#season-listing-accordian .season-title a").each(function(a,c){$(c).on("click",function(){var a=$(c).attr("aria-controls");_.each(b,function(b,c){a=="season-"+b.params.seasonId&&0==b.length&&b.load()})})});var d=new ShowUserControlsView({model:a});AnimeApp.vent.on("show:markedWatched",function(a){b&&_.each(b,function(a){a&&a.reload&&a.reload()})}),AnimeApp.userControls.show(d)},mainPage:function(a,b,c,d,e,f){a&&AnimeApp.simulcastShows&&AnimeApp.simulcastShows.show(a),isIphone||isIpad||b&&AnimeApp.recentlyViewedShows&&AnimeApp.recentlyViewedShows.show(b),c&&AnimeApp.popularShows&&AnimeApp.popularShows.show(c),d&&AnimeApp.recentShows&&AnimeApp.recentShows.show(d),e&&AnimeApp.myEpisodes&&AnimeApp.myEpisodes.show(e),f&&AnimeApp.recentEpisodes&&AnimeApp.recentEpisodes.show(f)},searchResultsPage:function(a,b){var c=new ShowCardCollectionView({collection:a,infiniteScroll:!0});AnimeApp.showResults.show(c);var d=new EpisodeCardCollectionView({collection:b,infiniteScroll:!0});AnimeApp.episodeResults.show(d)},browseShows:function(a,b){AnimeApp.shows.show(a)},simulcastsPage:function(a,b,c,d){a&&AnimeApp.activeSimulcasts.show(a),b&&AnimeApp.recentSimulcasts.show(b),c&&AnimeApp.latestEpisodes.show(c),d&&AnimeApp.upcomingEpisodes.show(d)}}),VideoEntry=CoreModel.extend({urlRoot:"api/videoentries",initialize:function(a){this.initCalculatedFields()},initCalculatedFields:function(){this.set("isAvod",this.isAvod()),this.set("isSvod",this.isSvod())},isAvod:function(){return this.checkRight(VideoEntry.Rights.AVOD)},isSvod:function(){return this.checkRight(VideoEntry.Rights.SVOD)},checkRight:function(a){var b=this.get("videoRights");if(b){var c=_.find(b,function(b){return b.right.name==a});if(c){if(!window.SERVER_TIME)return!0;if((c.startDate<window.SERVER_TIME||null==c.startDate)&&(window.SERVER_TIME<c.endDate||null==c.endDate))return!0}}return!1}},{Rights:{AVOD:"AVOD",SVOD:"SVOD"}}),PlaylistVideoEntryCollection=CoreCollection.extend({url:"/api/playlistvideoentries",model:function(a,b){return new PlaylistVideoEntry(a,b)}}),VideoEntryCollection=CoreCollection.extend({url:"/api/videoentries",model:function(a,b){return new VideoEntry(a,b)}}),User=CoreModel.extend({urlRoot:"api/users",initialize:function(a){},isInRole:function(a){var b=this.get("roles");if(b){var c=_.find(b,function(b){return b.name===a});return c?!0:!1}},hasPermission:function(a,b){var c=this.get("permissions");if(c){var d=_.find(c,function(c){return"undefined"!=typeof b?c.value===a&&c.resourceId&&c.resourceId===b:c.value===a});if(d)return!0}return!1},permissionsForVideoEntry:function(a){var b={},c=a.hasSubbedVideo&&this.hasPermission(User.Permissions.WATCH_SUBBED),d=a.hasDubbedVideo&&this.hasPermission(User.Permissions.WATCH_DUBBED),e=a.isAvod&&this.hasPermission(User.Permissions.WATCH_AVOD)||a.isSvod&&this.hasPermission(User.Permissions.WATCH_SVOD);return b.canWatchSubbed=e&&c,b.canWatchDubbed=e&&d,b.canWatch=e&&(c||d),b}},{Roles:{USER:"user",SUBSCRIBER:"subscriber",STAFF:"staff"},Permissions:{WATCH_VIDEO_QUALITY:"watchVideoQuality",WATCH_NO_ADS:"watchNoAds",WATCH_AVOD:"watchAvod",WATCH_SVOD:"watchSvod",WATCH_SUBBED:"watchSubbed",WATCH_DUBBED:"watchDubbed",CAST_VIDEOS:"castVideos"}}),Video=CoreModel.extend({urlRoot:"api/videos",initialize:function(a){this.orderInstances(),this.initVideoEntry()},orderInstances:function(){if(this.get("videoInstances")){var a=_.sortBy(this.get("videoInstances"),function(a){return a.bitrate},this);this.set("videoInstances",a)}},initVideoEntry:function(){var a=new VideoEntry(this.get("videoEntry"));a&&(a.initCalculatedFields(),this.set("videoEntry",a.toJSON()))},getHighestQualityInstance:function(){return this.get("videoInstances")&&this.get("videoInstances").length>0?this.get("videoInstances")[this.get("videoInstances").length-1]:null},getLowestQualityInstance:function(){return this.get("videoInstances")&&this.get("videoInstances").length>0?this.get("videoInstances")[0]:null}}),VideoCollection=CoreCollection.extend({url:"/api/videos",model:function(a,b){return new Video(a,b)}}),GenreCollection=CoreCollection.extend({url:"/api/genres",model:function(a,b){return new Genre(a,b)}}),Chromecast=function(a){a.currentMediaSession=null,a.session=null,a.localPlayerState=PLAYER_STATE.IDLE,this.positionTimer=null,this.castPosition=null,a.castingState={castAvailable:!1,casting:!1,deviceState:DEVICE_STATE.IDLE,castPlayerState:PLAYER_STATE.IDLE,setCasting:function(a){this.castPlayerState=a,this.casting=a!=PLAYER_STATE.IDLE},setDeviceState:function(a){this.deviceState=a,this.castAvailable=a==DEVICE_STATE.ACTIVE}},a.lastHbCheck=new Date,a.isMute=null,a.currentVolume=0,a.initCast=function(){chrome.cast&&chrome.cast.isAvailable||setTimeout(this.initializeCastApi,1e3)},a.initializeCastApi=function(){if(!chrome.cast||!chrome.cast.isAvailable)return void setTimeout(a.initializeCastApi,2e3);var b=new chrome.cast.SessionRequest(STYLED_RECEIVER_APP_ID),c=new chrome.cast.ApiConfig(b,a.sessionListener,a.receiverListener);chrome.cast.initialize(c,a.onInitSuccess,a.onChromecastError)},a.onInitSuccess=function(){},a.onChromecastError=function(b){console.log(b),a.castingState.setDeviceState(DEVICE_STATE.ERROR)},a.sessionListener=function(b){a.session=b,a.castingState.setDeviceState(DEVICE_STATE.ACTIVE),a.isMute=b.receiver.volume.muted,a.currentVolume=100*b.receiver.volume.level,a.session.media[0]?a.loadMediaFromSession(a.session.media[0]):a.loadChromecastMedia(),a.session.addUpdateListener(a.sessionUpdateListener)},a.receiverListener=function(b){b===chrome.cast.ReceiverAvailability.AVAILABLE?(a.castingState.setDeviceState(DEVICE_STATE.ACTIVE),a.adShowing==ADVERT_STATE.NONE&&$(".cast-icon").removeClass("hidden")):(a.castingState.setDeviceState(DEVICE_STATE.IDLE),a.session||$(".cast-icon").addClass("hidden"),console.log("No receiver was found"))},a.doChromecast=_.wrap(a.doChromecast,function(b,c){return a.session?a.session.stop(function(){},a.onLaunchError):(b&&b.call(a,c),"PLAYING"==a.getLocalPlayerState()?a.localPlayerState=PLAYER_STATE.PLAYING:a.localPlayerState=PLAYER_STATE.PAUSED,$(".video-overlayer").addClass("overlayer-hidden"),a.showLoader(),chrome.cast.requestSession(a.onRequestSessionSuccess,a.onLaunchError)),!1}),a.onRequestSessionSuccess=function(b){a.session=b,a.castingState.setDeviceState(DEVICE_STATE.ACTIVE),a.castingState.setCasting(PLAYER_STATE.LOADING),a.loadChromecastMedia(),a.session.addUpdateListener(a.sessionUpdateListener),a.updateCastingUI();try{Utils.trackEvent("Casting","Session Started","User"),a.model.get("videoEntry").slug}catch(c){}},a.onStopSessionSuccess=function(){Utils.trackEvent("Casting","Session Stopped","User"),a.castingState.setCasting(PLAYER_STATE.IDLE),a.resetMediaPlayerUI(),a.lastHbCheck=new Date(0),a.updateChromecastPositionTimer(),a.currentPosition=a.castPosition,a.stopPositionTimer(),a.session=null,a.currentMediaSession=null,a.accurateDuration=!1,a.loadVideo(a.playlistPosition)},a.onLaunchError=function(b){console.log("launch error"),a.castingState.setCasting(PLAYER_STATE.IDLE),a.resetMediaPlayerUI()},a.sessionUpdateListener=function(b){b||a.onStopSessionSuccess()},a.resetMediaPlayerUI=function(){$(".video-overlayer").removeClass("casting"),$("#video-holding-still").addClass("hidden"),a.videoData.currentView.render()},a.loadChromecastMedia=function(){if(a.session){var b=a.getVideoUrl(),c=new chrome.cast.media.MediaInfo(b,"video/mp4"),d="";this.model.get("videoEntry").showPortraitInstance.imageInfo&&(d=this.model.get("videoEntry").showPortraitInstance.imageInfo.fullPath);var e=new chrome.cast.Image(d),f="";this.model.get("videoEntry").thumbnailInstance.imageInfo&&(f=this.model.get("videoEntry").thumbnailInstance.imageInfo.fullPath);var g=new chrome.cast.Image(f),h=new chrome.cast.media.TvShowMediaMetadata;h.episode=this.model.get("videoEntry").sequence,h.title=this.model.get("videoEntry").showTitle+" - Ep "+this.model.get("videoEntry").episodeNumber+" - "+this.model.get("videoEntry").name,h.seriesTitle=this.model.get("videoEntry").showTitle,h.images=[e,g],c.metadata=h;var i={"title:":this.model.get("videoEntry").name,thumb:d,showName:h.title,url:Backbone.history.fragment,videoEntryId:this.model.get("videoEntry").id};c.customData=i;var j=new chrome.cast.media.LoadRequest(c);j.autoplay=this.autoplay;var k=this.model.get("videoEntry").slug;Utils.trackEvent("Casting","Video Loaded",k);var l=this.model.get("videoEntry").playbackPosition&&this.model.get("videoEntry").playbackPosition.complete;j.currentTime=l?0:a.currentPosition||!this.model.get("videoEntry").playbackPosition?a.currentPosition:this.model.get("videoEntry").playbackPosition.position,a.pauseLocalPlayer(),a.localPlayerState=PLAYER_STATE.PAUSED,a.showLoader(),a.castingState.setCasting(PLAYER_STATE.LOADING),a.session.loadMedia(j,a.onMediaDiscovered,a.onLoadMediaError);var m=a.model.get("videoInstances"),n="None";if(m)for(var o=0;o<m.length;o++)if(m[o].videoQuality.id==a.streamQuality){n=m[o].videoQuality.name;break}a.analyticsVideoStarted!==a.model.get("videoEntry").slug&&(null===a.model.get("videoEntry").playbackPosition?a.analyticsVideoStarted!==a.model.get("videoEntry").slug&&(Utils.trackEvent("Casting","Video Started",a.model.get("videoEntry").slug),a.analyticsVideoStarted=a.model.get("videoEntry").slug):a.playbackPosition.get("complete")===!1&&(Utils.trackEvent("Casting","Video Resumed",a.model.get("videoEntry").slug),a.analyticsVideoStarted=a.model.get("videoEntry").slug))}},a.startPositionTimer=function(){clearInterval(a.positionTimer),a.positionTimer=0,a.positionTimer=setInterval(a.updateChromecastPositionTimer,1e3)},a.stopPositionTimer=function(){clearInterval(a.positionTimer),a.positionTimer=0},a.updateChromecastPositionTimer=function(){if(a.session&&a.session.media.length>0){a.castPosition=a.session.media[0].getEstimatedTime();var b=a.session.media[0].media.duration;a.updateSeekBar(a.castPosition/b*100),a.updateClockPosition(a.castPosition),a.setClockDuration(b),a.accurateDuration=!0;var c=a.nextVideoWidget.currentView.model.get("id");c&&(b-a.castPosition<=60||a.nextHover)?$("#next-video-container").is(":visible")||$("#next-video-container").fadeIn():$("#next-video-container").is(":visible")&&$("#next-video-container").fadeOut();var d=a.prevVideoWidget.currentView.model.get("id");d&&a.prevHover?$("#prev-video-container").is(":visible")||$("#prev-video-container").fadeIn():$("#prev-video-container").is(":visible")&&$("#prev-video-container").fadeOut();var e=new Date;if("undefined"==typeof a.lastHbCheck||e.getTime()-a.lastHbCheck.getTime()>HEARTBEAT_TIMEOUT){var f=a.castPosition/b,g=!1;if(f>=.85)if(g=!0,a.completeTracked)a.completeTracked=!1;else{var h=this.model.get("videoEntry").slug;Utils.trackEvent("Casting","Video Complete",h),a.completeTracked=!0}a.savePlaybackPosition(a.castPosition,g),a.lastHbCheck=e}}},a.onMediaDiscovered=function(b){a.castingState.setCasting(PLAYER_STATE.PLAYING),a.currentMediaSession=b,a.currentMediaSession.addUpdateListener(a.mediaStatusUpdateHandler),a.startPositionTimer(),a.updateCastingUI()},a.updateCastingUI=function(){if(!a.model.get("showingAdvert")){$(".video-overlayer").removeClass("overlayer-hidden"),$(".video-overlayer").addClass("casting"),$("#video-holding-still").removeClass("hidden");var b="";a.model.get("videoEntry").largeInstance.imageInfo&&(b=a.model.get("videoEntry").largeInstance.imageInfo.fullPath),$("#video-holding-still").css("background-image","url("+b+")"),a.videoData.currentView.render(),a.updateChromecastPositionTimer(),a.castingState.castPlayerState==PLAYER_STATE.PLAYING?a.showPlaying():a.showPaused()}},a.getVideoUrl=function(){return this.model.getLowestQualityInstance().httpUrl},a.loadMediaFromSession=function(b){a.castingState.setCasting(b.playerState),this.currentMediaSession=b,this.castPlayerState=a.getPlayerState(this.session.media[0].playerState),this.currentMediaTime=a.session.media[0].currentTime;var c=this.model.get("videoEntry").slug;return Utils.trackEvent("Casting","Video Loaded",c),a.model.get("videoEntry").id!=this.currentMediaSession.media.customData.videoEntryId?void a.loadChromecastMedia():(a.pauseLocalPlayer(),a.updateCastingUI(),a.castingState.castPlayerState==PLAYER_STATE.PLAYING?(a.startPositionTimer(),a.showPlaying()):a.castingState.castPlayerState==PLAYER_STATE.PAUSED&&a.showPaused(),a.currentMediaSession.addUpdateListener(a.mediaStatusUpdateHandler),this.currentMediaDuration=this.currentMediaSession.media.duration?this.currentMediaSession.media.duration:-1,void(this.localPlayerState==PLAYER_STATE.PLAYING&&(this.localPlayerState=PLAYER_STATE.STOPPED)))},a.mediaStatusUpdateHandler=function(b){b||(a.currentMediaSession.idleReason==chrome.cast.media.IdleReason.FINISHED&&(a.playlistPosition++,a.playlistPosition<a.videos.length?a.moveInPlaylist(a.playlistPosition):a.onPlaylistComplete()),this.currentMediaTime=0,this.castPlayerState=PLAYER_STATE.IDLE,a.stopPositionTimer())},a.onLoadMediaError=function(){console.log("error loading media")},a.togglePlayState=_.wrap(a.togglePlayState,function(b,c){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a,c):a.castingState.castPlayerState==PLAYER_STATE.PLAYING?(a.castingState.setCasting(PLAYER_STATE.PAUSED),a.currentMediaSession.pause(null,a.mediaCommandSuccessCallback,a.errorHandler)):a.castingState.castPlayerState==PLAYER_STATE.PAUSED&&(a.currentMediaSession.play(null,a.mediaCommandSuccessCallback,a.errorHandler),a.currentMediaSession.addUpdateListener(a.mediaStatusUpdateHandler),a.castingState.setCasting(PLAYER_STATE.PLAYING))}),a.toggleMute=_.wrap(a.toggleMute,function(b){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a):(a.isMute=!a.isMute,a.session.setReceiverMuted(a.isMute,a.mediaCommandSuccessCallback,a.errorHandler),a.isMute?($(".video-volume").addClass("mute"),Utils.trackEvent("Casting","Mute Toggled","Mute On")):($(".video-volume").removeClass("mute"),Utils.trackEvent("Casting","Mute Toggled","Mute Off")))}),a.onPlaylistItem=_.wrap(a.onPlaylistItem,function(b,c){a.videos.at(a.playlistPosition).set("castingState",a.castingState),a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a,c):a.loadVideo(a.playlistPosition,!1)}),a.setVolume=_.wrap(a.setVolume,function(b,c){if(a.castingState.castPlayerState==PLAYER_STATE.IDLE)b&&b.call(a,c);else{$(".video-volume-control-bar").removeClass("hidden"),$(".video-volume").addClass("changing-volume"),$(".current-volume").css("width",a.currentVolume+"%");var d=c;this.session.setReceiverVolumeLevel(d/100,a.mediaCommandSuccessCallback,a.errorHandler),a.currentVolume=d,$(".current-volume").css("width",d+"%"),$(".video-volume").removeClass("mute")}}),a.volumeUp=_.wrap(a.volumeUp,function(b,c){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a,c):a.currentVolume<100&&a.setVolume(Math.min(a.currentVolume+5,100))}),a.volumeDown=_.wrap(a.volumeDown,function(b,c){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a,c):a.currentVolume>0&&a.setVolume(Math.max(a.currentVolume-5,0))}),a.seek=_.wrap(a.seek,function(b,c){if(a.castingState.castPlayerState==PLAYER_STATE.IDLE)b&&b.call(a,c);else{var d=new chrome.cast.media.SeekRequest;d.currentTime=c,a.currentMediaSession.seek(d,a.mediaCommandSuccessCallback,a.errorHandler)}}),a.seekForward=_.wrap(a.seekForward,function(b){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a):this.seek(a.castPosition+10)}),a.seekBack=_.wrap(a.seekBack,function(b){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a):this.seek(a.castPosition-10)}),a.onControlBarClick=_.wrap(a.onControlBarClick,function(b,c){if(a.currentMediaSession){var d=a.getClickPositionVideoPercentage(c),e=a.currentMediaSession.media.duration*(d/100);a.updateSeekBar(d);var f=new chrome.cast.media.SeekRequest;f.currentTime=e,a.currentMediaSession.seek(f,a.mediaCommandSuccessCallback,a.errorHandler)}else b&&b.call(a,c)}),a.showControls=_.wrap(a.showControls,function(b,c){a.currentMediaSession?($(".control-btn").show(),$(".video-overlayer").removeClass("overlayer-hidden"),a.checkPlaylistControls()):b&&b.call(a,c)}),a.onPause=_.wrap(a.onPause,function(b,c){a.castingState.castPlayerState!=PLAYER_STATE.IDLE||b&&b.call(a,c)}),a.onIdle=_.wrap(a.onIdle,function(b,c){a.castingState.castPlayerState!=PLAYER_STATE.IDLE?a.castingState.castPlayerState==PLAYER_STATE.PLAYING?a.showPlaying():a.showPaused():b&&b.call(a,c)}),a.onBuffer=_.wrap(a.onBuffer,function(b,c){a.castingState.castPlayerState!=PLAYER_STATE.IDLE?a.castingState.castPlayerState==PLAYER_STATE.PLAYING?a.showPlaying():a.showPaused():b&&b.call(a,c)}),a.nextVideo=_.wrap(a.nextVideo,function(b,c){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a,c):(a.playlistPosition++,a.playlistPosition<a.videos.length&&a.moveInPlaylist(a.playlistPosition))}),a.prevVideo=_.wrap(a.prevVideo,function(b,c){a.castingState.castPlayerState==PLAYER_STATE.IDLE?b&&b.call(a,c):(a.playlistPosition--,a.playlistPosition>=0&&a.moveInPlaylist(a.playlistPosition))}),a.moveInPlaylist=function(b){if(b>=a.videos.size())return a.playlistPosition=b,a.onPlaylistComplete();var c=a.videos.at(b),d=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(c.get("videoEntry")):{};if(d.canWatch){a.loadVideo(b,!1),a.model=c,null===a.model.get("videoEntry").playbackPosition?(a.playbackPosition=new PlaybackPosition,a.playbackPosition.set("videoEntryId",this.model.get("videoEntry").id),a.currentPosition=0):(a.playbackPosition=new PlaybackPosition(a.model.get("videoEntry").playbackPosition),a.playbackPosition.complete?(a.model.get("videoEntry").playbackPosition=0,a.currentPosition=0):a.currentPosition=a.playbackPosition.position),a.loadChromecastMedia(),a.videoData.currentView.model=a.model,a.videoData.currentView.render();var e=new Video;b<=a.videos.length-2&&(e=a.videos.at(b+1)),a.nextVideoWidget.currentView.model=e,a.nextVideoWidget.currentView.render();var f=new Video;b>0&&(f=a.videos.at(b-1)),this.prevVideoWidget.currentView.model=f,this.prevVideoWidget.currentView.render(),a.videos.at(b).set("castingState",a.castingState),a.pauseLocalPlayer(),a.updateCastingUI(),AppRouter.navigate(a.baseUrl+a.model.get("videoEntry").slug+a.suffix,{trigger:!1,replace:!0}),a.checkPlaylistControls(),a.playbackPosition.unset("percentageWatched"),a.playbackPosition.unset("positionInMinutes"),Utils.trackEvent("Video Player","Playlist Item Changed",this.model.get("videoEntry").slug)}else window.location.href="/"+a.baseUrl+c.get("videoEntry").slug,a.session&&a.session.stop(function(){},a.onLaunchError);a.loadChromecastMedia(),a.videoData.currentView.model=a.model,a.videoData.currentView.render();var e=new Video;b<=a.videos.length-2&&(e=a.videos.at(b+1)),a.nextVideoWidget.currentView.model=e,a.nextVideoWidget.currentView.render();var f=new Video;b>0&&(f=a.videos.at(b-1)),this.prevVideoWidget.currentView.model=f,this.prevVideoWidget.currentView.render(),a.videos.at(b).set("castingState",a.castingState),a.pauseLocalPlayer(),a.updateCastingUI(),AppRouter.navigate(a.baseUrl+a.model.get("videoEntry").slug+a.suffix,{trigger:!1,replace:!0}),a.checkPlaylistControls(),a.playbackPosition.unset("percentageWatched"),a.playbackPosition.unset("positionInMinutes"),Utils.trackEvent("Casting","Playlist Item Changed",this.model.get("videoEntry").slug)},a.onAdImpression=_.wrap(a.onAdImpression,function(b,c){a.castingState.deviceState==DEVICE_STATE.ACTIVE&&$(".cast-icon").addClass("hidden"),b&&b.call(a,c),a.session&&(a.resetMediaPlayerUI(),a.updateCastingUI())}),a.onAdComplete=_.wrap(a.onAdComplete,function(b,c){a.currentMediaSession||a.session?(b.call(a,c),a.pauseLocalPlayer(),a.updateCastingUI()):b&&b.call(a,c),a.castingState.deviceState==DEVICE_STATE.ACTIVE&&$(".cast-icon").removeClass("hidden")}),a.onTime=_.wrap(a.onTime,function(b,c){a.currentMediaSession||a.session?a.pauseLocalPlayer():b&&b.call(a,c)}),a.onPlay=_.wrap(a.onPlay,function(b,c){a.castingState.castPlayerState!=PLAYER_STATE.IDLE||b&&b.call(a,c)}),a.mediaCommandSuccessCallback=function(){a.currentMediaSession&&(a.castingState.castPlayerState==PLAYER_STATE.PLAYING?(a.showPlaying(),a.startPositionTimer()):a.castingState.castPlayerState==PLAYER_STATE.PAUSED&&(a.showPaused(),a.stopPositionTimer()))},a.playItemAtPosition=_.wrap(a.playItemAtPosition,function(b){a.castingState.castPlayerState==PLAYER_STATE.IDLE&&b&&b.call(a)}),a.errorHandler=function(){console.log("command error!")},a.getPlayerState=function(a){switch(a){case chrome.cast.media.PlayerState.BUFFERING:case chrome.cast.media.PlayerState.PLAYING:return PLAYER_STATE.PLAYING;case chrome.cast.media.PlayerState.IDLE:return PLAYER_STATE.IDLE;case chrome.cast.media.PlayerState.PAUSED:return PLAYER_STATE.PAUSED}}},VideoEntryView=CoreModel.extend({url:"/api/videoentryviews",initialize:function(a){}}),VideoDataView=Backbone.Marionette.ItemView.extend({template:"videoData",className:"video-data",events:{"click .action-switch-dubbed":"switchToDubbed","click .action-switch-subbed":"switchToSubbed"},initialize:function(a){this.permissions=a.permissions},serializeData:function(){var a="undefined"!=typeof this.model?this.model.toJSON():{};return{video:a,permissions:this.permissions}},switchToSubbed:function(a){return AnimeApp.vent.trigger("videoPlayer:switchedToSubbed",this.model),Utils.trackEvent("Video Player","Language Changed","Subbed"),!1},switchToDubbed:function(a){return AnimeApp.vent.trigger("videoPlayer:switchedToDubbed",this.model),Utils.trackEvent("Video Player","Language Changed","Dubbed"),!1}}),NextVideoView=Backbone.Marionette.ItemView.extend({template:"nextVideo",className:"video-up-next",events:{"click .action-play-next":"playNext"},playNext:function(a){return AnimeApp.vent.trigger("videoPlayer:playNext"),!1}}),PrevVideoView=Backbone.Marionette.ItemView.extend({template:"prevVideo",className:"video-up-next prev-side",events:{"click .action-play-prev":"playPrev"},onShow:function(){},playPrev:function(a){return AnimeApp.vent.trigger("videoPlayer:playPrev"),!1}}),VideoPlayerView=Backbone.Marionette.Layout.extend({template:"player",ads:[],showAdUiAboveControls:!1,adTimeoutInterval:null,adsPerAip:2,adUrl:null,viewedAds:0,AD_TIMEOUT_LIMIT:15e3,currentMouse:null,currentPosition:0,videoDuration:0,currentVideoId:0,hbInterval:null,playbackPosition:null,suffix:"",controlsDisabled:!1,pauseTimeout:null,returnUrl:null,updateUrl:null,playlistStarted:!1,playlistPosition:0,detectAdblock:!0,adRequested:!1,isAdPlaying:!1,nextHover:!1,prevHover:!1,isMobile:!1,streamQuality:null,qualityLevels:null,completeTracked:!1,adShowing:ADVERT_STATE.NONE,controlsTimer:null,controlsBuffer:null,prerollShown:!1,userWatchesAds:!0,permissions:{},midRollStarted:{},midRollTimecodes:{},AD_GRACE_PERIOD_MILLISECONDS:3e4,lastAdFinished:0,lastAdPlayedPlaybackPosition:-1,videoResumePositionAfterAd:-1,autoplay:!0,events:{"click .video-volume":"toggleMute","click .video-play":"togglePlayState","click .video-fullscreen":"toggleFullscreen","click .video-control-bar":"onControlBarClick","click .potential-volume":"onVolumeClick","mouseenter .video-volume":"onVolumeEnter","click .video-return":"closeVideo","click .video-next":"nextVideo","click .video-dismiss-controls":"dismissControls","mouseenter .video-next":"nextVideoHoverOn","mouseleave .video-next":"nextVideoHoverOff","mouseenter .video-prev":"prevVideoHoverOn","mouseleave .video-prev":"prevVideoHoverOff","click .video-prev":"prevVideo","click .cast-icon":"doChromecast","click .stream-option":"streamQualitySelected","click .high-disabled":"showSubscriptionModal"},regions:{videoData:"#video-info-container",prevVideoWidget:"#prev-video-container",nextVideoWidget:"#next-video-container"
},initialize:function(a){if(this.userWatchesAds=!AnimeApp.currentUser.hasPermission(User.Permissions.WATCH_NO_ADS),this.detectAdblock&&(this.detectAdblock=this.userWatchesAds),a.baseUrl?this.baseUrl=a.baseUrl:this.baseUrl="player/",null!=a.autoplay&&(this.autoplay=a.autoplay),a.returnUrl&&(this.returnUrl=a.returnUrl),a.updateUrl&&(this.updateUrl=a.updateUrl),a.ads?this.ads=a.ads:this.ads||(this.ads=[]),a.playlistPosition?this.playlistPosition=a.playlistPosition:this.playlistPosition=0,a.videos&&(this.videos=a.videos),Backbone.history.fragment.endsWith("subtitles")?this.suffix="/subtitles":Backbone.history.fragment.endsWith("dubbed")&&(this.suffix="/dubbed"),AnimeApp.vent.on("videoPlayer:switchedToDubbed",_.bind(this.switchToDubbed,this)),AnimeApp.vent.on("videoPlayer:switchedToSubbed",_.bind(this.switchToSubbed,this)),AnimeApp.vent.on("videoPlayer:playNext",_.bind(this.nextVideo,this)),AnimeApp.vent.on("videoPlayer:playPrev",_.bind(this.prevVideo,this)),this.initKeyShortcuts(),"undefined"!=typeof chrome){new Chromecast(this);this.initCast()}},adblockModal:function(){this.detectAdblock&&this.adblocked&&Utils.showAdblockModal()},startAdblockChecker:function(){},initKeyShortcuts:function(){$("body.watch").on("keyup",_.bind(this.onKeyup,this)),$("body.watch").on("keydown",_.bind(this.onKeydown,this))},onShow:function(){this.showJWPlayerControls=!1,isMobile&&($(".video-volume").remove(),$(".video-overlayer").hide(),this.showJWPlayerControls=!0,this.isMobile=!0),$(".has-tooltip").tooltip({container:".video-data"}),null!=this.model&&(this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.get("videoEntry")):{});var a=new VideoDataView({model:this.model,permissions:this.permissions});this.videoData.show(a);var b=new Video;this.playlistPosition<=this.videos.length-2&&(b=this.videos.at(this.playlistPosition+1));var c=new NextVideoView({model:b});this.nextVideoWidget.show(c);var d=new Video;this.playlistPosition>0&&(d=this.videos.at(this.playlistPosition-1));var e=new PrevVideoView({model:d});this.prevVideoWidget.show(e),this.setupPlayer(this.showJWPlayerControls),screenfull.enabled||$(".video-fullscreen").css("display","none"),this.returnUrl||$(".video-return").remove(),$(window).on("mousewheel",_.bind(this.onMouseWheel,this)),$("body.watch").on("mousemove",_.bind(this.bodyWatcher,this)),$("body.watch").on("mousewheel",_.bind(this.bodyWatcher,this)),screenfull&&screenfull.raw&&screenfull.raw.fullscreenchange&&$(document).on(screenfull.raw.fullscreenchange,_.bind(this.onFullscreenChange,this)),$(window).on("beforeunload unload",_.bind(this.close,this)),this.onPlaylistItem(this.playlistPosition)},setupPlayer:function(a){var b=jwplayer();b&&b.stop&&b.stop(),jwplayer("video-component").setup({controls:a,displaytitle:!1,displaydescription:!1,primary:"html5",playlist:this.loadVideo(this.playlistPosition,!1,!0,!0),height:"100%",width:"100%",stagevideo:!1,autostart:this.autoplay&&!this.isMobile,advertising:this.getJWAdvertising()}),jwplayer().onTime(_.bind(this.onTime,this)),jwplayer().on("bufferChange",_.bind(this.updateBuffer,this)),jwplayer().on("buffer",_.bind(this.onBuffer,this)),jwplayer().on("play",_.bind(this.onPlay,this)),jwplayer().on("pause",_.bind(this.onPause,this)),jwplayer().on("idle",_.bind(this.onIdle,this)),jwplayer().on("complete",_.bind(this.onComplete,this)),jwplayer().on("ready",_.bind(this.onReady,this)),jwplayer().on("playlistItem",_.bind(this.onPlaylistItem,this)),jwplayer().on("seek",_.bind(this.onSeek,this)),jwplayer().on("levelsChanged",_.bind(this.onQualityChange,this)),jwplayer().on("levels",_.bind(this.onQualityLevels,this)),jwplayer().on("beforePlay",_.bind(this.onBeforePlay,this)),jwplayer().on("adBlock",_.bind(this.onAdBlock,this)),jwplayer().on("adError",_.bind(this.onAdError,this)),jwplayer().on("adSkipped",_.bind(this.onAdSkipped,this)),jwplayer().on("adComplete",_.bind(this.onAdComplete,this)),jwplayer().on("adImpression",_.bind(this.onAdImpression,this)),jwplayer().on("adClick",_.bind(this.onAdClick,this)),jwplayer().on("adCompanions",_.bind(this.onAdCompanions,this)),jwplayer().on("adTime",_.bind(this.onAdTime,this)),jwplayer().on("playlistComplete",_.bind(this.onPlaylistComplete,this)),jwplayer().on("error",function(a){Utils.trackEvent("Video Player","Error",a.message+"; "+window.location.href)})},getJWAdvertising:function(){if(this.userWatchesAds){for(var a=this.ads,b=0,c=Math.random(),d=0,e=0;e<a.length;e++){var f=d+a[e][this.isMobile?"showRatioForMobile":"showRatio"];if(f>c){b=e;break}d=f}return this.adsPerAip=a[b].adsPerSequence,this.adUrl=a[b].tag,this.showAdUiAboveControls=a[b].showAdUiAboveControls,{client:a[b].client,tag:null,companiondiv:{id:"text-ad-container",width:0,height:0}}}return{}},onAdBlock:function(){var a=this.model.get("videoEntry");this.detectAdblock&&"Trailer"!==a.videoEntryType.name&&"Extra"!==a.videoEntryType.name&&(this.isAdBlocked=!0,jwplayer().stop(),Utils.showAdblockModal())},nextVideoHoverOn:function(a){this.nextHover=!0,"PLAYING"!=this.getLocalPlayerState()&&($("#next-video-container").is(":visible")||$("#next-video-container").fadeIn())},nextVideoHoverOff:function(a){this.nextHover=!1,"PLAYING"!=this.getLocalPlayerState()&&$("#next-video-container").is(":visible")&&$("#next-video-container").fadeOut()},prevVideoHoverOn:function(a){this.prevHover=!0,"PLAYING"!=this.getLocalPlayerState()&&($("#prev-video-container").is(":visible")||$("#prev-video-container").fadeIn())},prevVideoHoverOff:function(a){this.prevHover=!1,"PLAYING"!=this.getLocalPlayerState()&&$("#prev-video-container").is(":visible")&&$("#prev-video-container").fadeOut()},onReady:function(){$(".current-volume").css("width",jwplayer().getVolume()+"%")},loadVideo:function(a,b,c,d){this.playlistPosition;this.playlistPosition=a;var e=this.videos.at(a);this.adblockModal();var f;e&&(this.analyticsVideoLanguage=e.get("hardSubbed")?"Subbed":"Dubbed",f=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(e.get("videoEntry")):{});var g=[];if(this.isMobile){if(a>0){var h=this.videos.at(a-1),i=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(h.get("videoEntry")):{};i.canWatch&&g.push({sources:[{file:h.getLowestQualityInstance().httpUrl,type:"mp4"}]})}if(f.canWatch?g.push({sources:[{file:e.getLowestQualityInstance().httpUrl,type:"mp4"}]}):(window.location.href="/"+this.baseUrl+e.get("videoEntry").slug,b=!1),a<this.videos.length-1){var j=this.videos.at(a+1),k=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(j.get("videoEntry")):{};k.canWatch?g.push({sources:[{file:j.getLowestQualityInstance().httpUrl,type:"mp4"}]}):g.push({sources:[{file:"END",type:"mp4"}]})}else g.push({sources:[{file:"END",type:"mp4"}]})}else{var l=[];if(f&&f.canWatch){if(null!=e&&null!=e.get("videoInstances"))for(var m=0;m<e.get("videoInstances").length;m++)l.push({file:e.get("videoInstances")[m].httpUrl,type:"mp4"});g.push({title:e.get("videoEntry").showTitle,description:e.get("videoEntry").synopsis,mediaid:e.get("videoEntry").id,sources:l,image:((e.get("videoEntry").largeInstance||{}).imageInfo||{}).fullPath})}else d&&(window.location.href="/"+this.baseUrl+e.get("videoEntry").slug)}var n=this;if(a>1&&null==this.videos.at(a-2).get("videoInstances")){var o=a-2;$.getJSON("/api/videos/"+this.updateUrl+"?videoId="+this.videos.at(o).get("id")+"&position="+o+"&forward="+!1,function(a){o-=a.length-1,$.each(a,function(){null==n.videos.models[o].get("videoInstances")&&(n.videos.models[o]=new Video(this),n.playlistPosition==o&&n.loadVideo(n.playlistPosition),o==n.playlistPosition-2&&n.videoData.currentView&&n.videoData.currentView.render()),o++})})}if(a<this.videos.size()-2&&null==this.videos.at(a+2).get("videoInstances")){var p=a+2;null==this.videos.at(a+1).get("videoInstances")&&(p=a+1),$.getJSON("/api/videos/"+this.updateUrl+"?videoId="+this.videos.at(p).get("id")+"&position="+p+"&forward="+!0,function(a){$.each(a,function(){null==n.videos.models[p].get("videoInstances")&&(n.videos.models[p]=new Video(this),n.playlistPosition==p&&n.loadVideo(n.playlistPosition),n.playlistPosition+2==p&&n.videoData.currentView&&n.videoData.currentView.render()),p++})})}if(null!=e.get("videoInstances"))return b===!1?g:(this.prerollShown=!1,this.lastAdFinished=c===!0?0:this.lastAdFinished,jwplayer().load(g),this.isMobile&&this.playlistPosition>0&&jwplayer().playlistItem(1),setTimeout(function(){jwplayer().play(!n.isMobile)},10),void 0)},onClose:function(){this.updatePosition(),$("body.watch").off("mousemove"),$("body.watch").off("mousewheel"),$(document).off(screenfull.raw.fullscreenchange),$(window).off("mousewheel"),$("body.watch").off("keyup"),$("body.watch").off("keydown"),jwplayer().remove()},setAdLoadTimeout:function(){this.cancelAdLoadTimeout();var a;this.adTimeoutInterval=a=setTimeout(_.bind(function(){this.adTimeoutInterval==a&&(this.cancelAdLoadTimeout(),this.cancelAdLoadTimeout(a),this.onAdError(null))},this),this.AD_TIMEOUT_LIMIT)},cancelAdLoadTimeout:function(a){clearTimeout(null!=a?a:this.adTimeoutInterval),a||(this.adTimeoutInterval=null)},onBeforePlay:function(){var a=jwplayer().getPlaylistIndex();if(this.cancelAdLoadTimeout(),this.isMobile&&this.playlistPosition>0&&0==a){setTimeout(function(){jwplayer().playlistItem(1)},1)}else if(1==a||0==a&&0==this.playlistPosition||!this.isMobile){jwplayer().pause(!0).play(!0);var b=this.model.get("videoEntry");if(this.userWatchesAds&&"Trailer"!==b.videoEntryType.name&&"Extra"!==b.videoEntryType.name&&null!=this.adUrl)if(0==this.viewedAds){if(!this.prerollShown&&!this.adRequested&&(this.playAd()||(this.adShowing=ADVERT_STATE.NONE,this.prerollShown=!0),window.navigator.userAgent.indexOf("Nintendo WiiU")>=0)){var c=document.getElementsByTagName("video")[0];if(null!=c){c.style.zIndex="99999";var d=function(){c.style.zIndex="",c.removeEventListener("play",d),jwplayer().play(!0)};c.addEventListener("play",d)}jwplayer().play(!0)}}else this.setAdLoadTimeout();else this.prerollShown=!0,$(".video-control-bar").removeClass("hidden"),$(".video-preroll-bar").addClass("hidden"),this.adShowing==ADVERT_STATE.PREROLL&&this.updatePlayerPosition(),this.adShowing=ADVERT_STATE.NONE,this.showControlsAfterAdvert(),this.model.set("showingAdvert",!1),this.model.set("advertState",this.adShowing),this.videoData.currentView&&this.videoData.currentView.render()}},onAdError:function(a){var b=document.getElementById("video-component-wrapper");if(b&&(b.style.zIndex=""),this.cancelAdLoadTimeout(),this.viewedAds++,this.viewedAds<this.adsPerAip&&null!=this.adUrl)this.playAd(),this.setAdLoadTimeout();else if(this.onAdSequenceCompleted(),"html5"==jwplayer().getRenderingMode()){var c=_.bind(function(){return"PLAYING"!=this.getLocalPlayerState()?void setTimeout(c,50):void(-1==jwplayer().getDuration()&&(jwplayer().pause(!0),jwplayer().play(!0)))},this);c()}},onAdSkipped:function(a){},onAdImpression:function(a){if(this.showAdUiAboveControls){var b=document.getElementById("video-component-wrapper");b&&(b.style.zIndex=10003)}this.cancelAdLoadTimeout(),$(".video-control-bar").addClass("hidden"),$(".video-preroll-bar").removeClass("hidden"),clearInterval(this.hbInterval),this.hbInterval=0,this.hideControlsForAdvert(),this.showPlaying(),this.isAdPlaying=!0,this.model.set("showingAdvert",!0),this.model.set("advertState",this.adShowing),this.videoData.currentView&&this.videoData.currentView.render(),$("#prev-video-container").is(":visible")&&$("#prev-video-container").fadeOut(),$("#next-video-container").is(":visible")&&$("#next-video-container").fadeOut()},onAdTime:function(a){var b=a.duration-a.position;$("#ad-remaining").html(Math.round(b))},onAdComplete:function(a){var b=document.getElementById("video-component-wrapper");b&&(b.style.zIndex=""),this.cancelAdLoadTimeout(),this.viewedAds++,this.viewedAds<this.adsPerAip&&null!=this.adUrl?(this.playAd(),this.setAdLoadTimeout()):this.onAdSequenceCompleted()},onAdClick:function(a){this.isAdPlaying=!1,this.showPaused()},onAdCompanions:function(a){},onAdSequenceCompleted:function(){if(this.adRequested=!1,this.lastAdFinished=Date.now(),this.viewedAds=0,$(".video-control-bar").removeClass("hidden"),$(".video-preroll-bar").addClass("hidden"),this.adShowing!=ADVERT_STATE.NONE&&this.updatePlayerPosition(),this.adShowing=ADVERT_STATE.NONE,this.prerollShown=!0,this.isAdPlaying=!1,this.showControlsAfterAdvert(),this.model.set("showingAdvert",!1),this.model.set("advertState",this.adShowing),this.videoData.currentView&&this.videoData.currentView.render(),"flash"==jwplayer().renderingMode){var a=function(){jwplayer().play(!0)};setTimeout(a,100)}},playAd:function(){if($("#text-ad-container").empty(),null!=this.adUrl&&this.lastAdFinished<=Date.now()-this.AD_GRACE_PERIOD_MILLISECONDS){this.adRequested=!0;var a=this.adUrl;if(a instanceof Array){a=[];for(var b=0;b<this.adUrl.length;b++)a[b]=this.sanitizeAdUrl(this.adUrl[b])}else a=this.sanitizeAdUrl(a);return jwplayer().playAd(a),!0}return!1},sanitizeAdUrl:function(a){function b(a,b){return encodeURIComponent(b)}function c(a,c){return b(b(a,c))}var d=this.videos.at(playlistPosition),e="",f="",g="",h=0,i="";d&&(e=d.get("videoEntry").showTitle,f=d.get("videoEntry").showSlug,g=d.get("videoEntry").synopsis,h=d.get("videoEntry").id,i=_.map(d.get("videoEntry").genres||[],function(a,b,c){return a.slug}).join(","));var a=a.replace("[timestamp]",(new Date).getTime()).replace("[referrer_url]",encodeURIComponent(location.href)).replace("[title]",encodeURIComponent(e)).replace("[description]",encodeURIComponent(g)).replace("[video_id]",h).replace("[GENRE]",i).replace("[SHOW]",f).replace("[PLAYER_WIDTH]",window.innerWidth).replace("[PLAYER_HEIGHT]",window.innerHeight).replace(/\[URL_ESC:(.*?\[.*?\].*?|.*?)\]/g,b).replace(/\[URL_ESC_ESC:(.*?\[.*?\].*?|.*?)\]/g,c);return a},determineStreamQuality:function(a){var b=jwplayer().getQualityLevels(),c=0;return _.find(b,function(b){return c++,b.label==a}),c},onPlaylistItem:function(a){if(this.isMobile&&null!=a.index){if(0==a.index&&this.playlistPosition>0)return void(this.playlistStarted&&(this.playlistStarted=!1,this.prevVideo()));if(2==a.index||0==this.playlistPosition&&1==a.index)return void(this.playlistStarted&&(this.playlistStarted=!1,this.playlistPosition+1<this.videos.size()?this.nextVideo():(this.playlistPosition++,this.onPlaylistComplete())))}null!=a.index&&(this.playlistStarted=!0);var b=this.playlistPosition;this.adShowing=ADVERT_STATE.PREROLL,this.prerollShown=!1,$("#next-video-container").is(":visible")&&$("#next-video-container").hide(),$("#prev-video-container").is(":visible")&&$("#prev-video-container").hide(),clearInterval(this.hbInterval),this.hbInterval=0;var c="";this.model&&this.model.get("videoQuality")&&(c=this.model.get("videoQuality")),this.model=this.videos.at(b);var d=this.model.get("aips");if(this.midRollTimecodes={},d&&this.userWatchesAds)for(var e=0;e<d.length;e++)this.midRollStarted[d[e].id]=!1,this.midRollTimecodes[d[e].id]=this.getTimecodeSeconds(d[e].timecode);this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.get("videoEntry")):{},$("head title").html($("head meta[property*=site_name]").attr("content")+" - "+this.model.get("videoEntry").showTitle+" - Episode "+this.model.get("videoEntry").episodeNumber+" - "+this.model.get("videoEntry").name+" - Watch Online for Free"),this.model.set("videoQuality",c),this.onQualityLevels(),this.videoData.currentView.model=this.model,this.videoData.currentView.permissions=this.permissions,this.videoData.currentView.render();var f=new Video;b<=this.videos.length-2&&(f=this.videos.at(b+1)),this.nextVideoWidget.currentView.model=f,this.nextVideoWidget.currentView.render();var g=new Video;b>0&&(g=this.videos.at(b-1)),this.prevVideoWidget.currentView.model=g,this.prevVideoWidget.currentView.render(),AppRouter.navigate(this.baseUrl+this.model.get("videoEntry").slug+this.suffix,{trigger:!1,replace:!0}),this.checkPlaylistControls();var h=this.model.get("videoInstances"),i="None";if(h)for(var e=0;e<h.length;e++)if(h[e].videoQuality.id==this.streamQuality){i=h[e].videoQuality.name;break}null===this.model.get("videoEntry").playbackPosition?(this.playbackPosition=new PlaybackPosition,this.playbackPosition.set("videoEntryId",this.model.get("videoEntry").id),this.analyticsVideoStarted!==this.model.get("videoEntry").slug&&(null==document.referrer||-1===document.referrer.indexOf(this.model.get("videoEntry").slug))&&(Utils.trackEvent("Video Player","Video Started",this.model.get("videoEntry").slug),this.analyticsVideoStarted=this.model.get("videoEntry").slug)):(this.playbackPosition=new PlaybackPosition(this.model.get("videoEntry").playbackPosition),this.playbackPosition.get("complete")===!1&&(null==document.referrer||-1===document.referrer.indexOf(this.model.get("videoEntry").slug))&&(Utils.trackEvent("Video Player","Video Resumed",this.model.get("videoEntry").slug),this.analyticsVideoStarted=this.model.get("videoEntry").slug)),this.playbackPosition.unset("percentageWatched"),this.playbackPosition.unset("positionInMinutes"),this.updatePlayerPosition(),null==a.index||1!=a.index&&(0!=a.index||0!=this.playlistPosition)&&this.isMobile||Utils.trackEvent("Video Player","Playlist Item Changed",this.model.get("videoEntry").slug)},onQualityLevels:function(){this.extractQualityLevels()},extractQualityLevels:function(){var a=this.model.get("videoInstances");$.cookie("preferredQuality")?this.streamQuality=$.cookie("preferredQuality"):this.streamQuality=1|jwplayer().getCurrentQuality(),$(".stream-option").removeClass("active"),this.qualityLevels=[];for(var b=0;b<a.length;b++){var c="";if(a[b].bitrate==BITRATES.MEDIUM_QUALITY?c="medium-quality":a[b].bitrate==BITRATES.HIGH_QUALITY&&(c="high-quality"),null!=a[b].httpUrl){b==this.streamQuality&&this.model.set("videoQuality",c);var d={index:b,active:b==this.streamQuality,quality:a[b].videoQuality.id};this.qualityLevels.push(d)}else b==this.streamQuality&&(this.streamQuality=0)}if(a.length>0){var c=this.streamQuality,e=_.find(this.qualityLevels,function(a){return a.quality==c});if(null==e){for(;null==e&&2!=c;)c=4==c?3:2,e=_.find(this.qualityLevels,function(a){return a.quality==c});null==e&&(e=this.qualityLevels[0]),this.streamQuality=e.quality}this.model.set("videoQuality",e.quality),jwplayer().setCurrentQuality(e.index)}this.videoData.currentView&&this.videoData.currentView.render(),this.model.set("qualities",this.qualityLevels)},streamQualitySelected:function(a){var b=$(a.target).attr("class").replace("stream-option","").replace("active","").replace("quality-","").trim();if(null!=this.qualityLevels){var c=_.find(this.qualityLevels,function(a){return a.quality==b});if(c){var d=this.model.get("videoInstances"),e="None";if(d)for(var f=0;f<d.length;f++)if(d[f].videoQuality.id==b){e=d[f].videoQuality.name;break}if(this.streamQuality=c.quality,Utils.trackEvent("Video Player","Quality Changed",e),jwplayer().setCurrentQuality(c.index),$.cookie("preferredQuality",this.streamQuality,{expires:30,path:"/"}),this.videoData.currentView){var g=this.videoData.currentView;null!=a&&$(a.target).closest(".stream-options").removeClass("open"),setTimeout(function(){g.render()},100)}}}return!1},onQualityChange:function(a){if(null!=this.qualityLevels){var b=_.find(this.qualityLevels,function(b){return b.index===a.currentQuality});if(b&&(this.model.set("videoQuality",b.quality),this.videoData.currentView)){var c=this.videoData.currentView;setTimeout(function(){c.render()},100)}}},onPlaylistComplete:function(){this.returnUrl&&this.playlistPosition>=this.videos.size()?window.location.href=this.returnUrl:(jwplayer().pause(!0),this.showPaused(),this.showControls(!0))},onMouseWheel:function(a){-1==a.deltaY&&0!=jwplayer().getVolume()?this.volumeDown():1==a.deltaY&&100!=jwplayer().getVolume()&&this.volumeUp()},onKeyup:function(a){switch(a.keyCode){case 32:this.togglePlayState();break;case 70:this.toggleFullscreen();break;case 72:this.hideControls()}},onKeydown:function(a){switch(a.keyCode){case 38:this.volumeUp();break;case 40:this.volumeDown();break;case 37:this.seekBack();break;case 39:this.seekForward();break;case 27:return this.handleEscape(),a.preventDefault(),!1}},closeVideo:function(a){var b=this.returnUrl;Utils.trackEvent("Video Player","Back Button Clicked",b),window.location.href=b},dismissControls:function(a){this.stopPropagation(a),this.controlsDisabled=!0;var b=this;setTimeout(function(){b.controlsDisabled=!1},2500),this.hideControls()},toggleMute:function(a){this.stopPropagation(a),1==this.localPlayerIsMute()?(jwplayer().setMute(!1),$(".video-volume").removeClass("mute"),Utils.trackEvent("Video Player","Mute Toggled","Mute Off")):(jwplayer().setMute(!0),$(".video-volume").addClass("mute"),Utils.trackEvent("Video Player","Mute Toggled","Mute On")),$(".current-volume").css("width",jwplayer().getVolume()+"%")},togglePlayState:function(a){jwplayer().setControls(this.showJWPlayerControls),a&&$(a.target).parents(".btn,.btn-group").length>0||$(".dropdown-toggle").parents(".open").length>0||(this.stopPropagation(a),"PLAYING"==this.getLocalPlayerState()||"BUFFERING"==this.getLocalPlayerState()&&this.adShowing==ADVERT_STATE.NONE||this.adShowing!=ADVERT_STATE.NONE&&1==this.isAdPlaying?(this.adShowing==ADVERT_STATE.NONE?jwplayer().pause(!0):(jwplayer().pauseAd(),this.isAdPlaying=!1),this.showPaused()):("PAUSED"==this.getLocalPlayerState()||"IDLE"==this.getLocalPlayerState()||this.adShowing!=ADVERT_STATE.NONE&&0==this.isAdPlaying)&&(this.adShowing==ADVERT_STATE.NONE||this.autoplay===!1?(jwplayer().play(!0),this.autoplay=!0):(jwplayer().pauseAd(!1),this.isAdPlaying=!0),this.showPlaying()))},toggleFullscreen:function(a){this.stopPropagation(a),screenfull.toggle($("body")[0])},onFullscreenChange:function(a){$(".video-fullscreen").toggleClass("clicked"),Utils.trackEvent("Video Player","Fullscreen Toggled",screenfull.isFullscreen?"Fullscreen":"Windowed")},volumeUp:function(){jwplayer().getVolume()<=100&&this.setVolume(Math.min(jwplayer().getVolume()+5,100))},volumeDown:function(){jwplayer().getVolume()>=0&&this.setVolume(Math.max(jwplayer().getVolume()-5,0))},setVolume:function(a){this.showControls(!0,"volume"),$(".video-volume-control-bar").removeClass("hidden"),$(".video-volume").addClass("changing-volume"),$(".current-volume").css("width",jwplayer().getVolume()+"%"),jwplayer().setVolume(a),$(".current-volume").css("width",jwplayer().getVolume()+"%"),$(".video-volume").removeClass("mute")},seekForward:function(){this.seek(jwplayer().getPosition()+10),this.checkUnpaused()},seekBack:function(){this.seek(Math.max(jwplayer().getPosition()-10,0)),this.checkUnpaused()},seek:function(a){this.lastAdPlayedPlaybackPosition=Math.min(this.currentPosition>0?this.currentPosition:a,a),this.showControls(!0,"seek"),jwplayer().seek(a)},onSeek:function(){$(".video-buffering").removeClass("hidden")},checkUnpaused:function(){"PAUSED"==this.getLocalPlayerState()&&$(".video-play").removeClass("paused")},getDuration:function(){var a=jwplayer().getDuration();if(-1==a&&"html5"==jwplayer().getRenderingMode()){var b=document.getElementsByTagName("video")[0];if(null!=b)return b.duration}return a},onTime:function(a){this.currentPosition=a.position,-1==a.duration&&(a.duration=this.getDuration());var b=a.position/a.duration*100;if(this.updateSeekBar(b),this.updateClockPosition(jwplayer().getPosition()),this.adShowing==ADVERT_STATE.NONE){if(this.videoResumePositionAfterAd>=0&&1==this.accurateDuration?(jwplayer().seek(this.videoResumePositionAfterAd),this.videoResumePositionAfterAd=-1):-1!=a.duration&&1!=this.accurateDuration&&(this.setClockDuration(a.duration),this.updateAipBars(a.duration),this.accurateDuration=!0,this.playbackPosition&&!this.playbackPosition.get("complete")&&this.playbackPosition.get("position")>0&&(this.lastAdPlayedPlaybackPosition=this.playbackPosition.get("position"),jwplayer().seek(this.lastAdPlayedPlaybackPosition))),this.userWatchesAds){var c=this.model.get("aips");if(c)for(var d=c.length-1;d>=0;d--){var e=this.midRollTimecodes[c[d].id];if(void 0!=e&&this.currentPosition>=e&&e>this.lastAdPlayedPlaybackPosition&&(this.lastAdPlayedPlaybackPosition=e,0==this.midRollStarted[c[d].id])){var f=(new Date).getTime();(!this.lastAdFinished||f-this.lastAdFinished>this.AD_GRACE_PERIOD_MILLISECONDS)&&this.playAd()&&(this.videoResumePositionAfterAd=this.currentPosition,jwplayer().play(!1),this.setAdLoadTimeout(),this.adShowing=ADVERT_STATE.MIDROLL,this.midRollStarted[c[d].id]=!0);break}}}var g=this.nextVideoWidget?this.nextVideoWidget.currentView.model.get("id"):null;g&&(a.duration-a.position<=15||this.nextHover)?$("#next-video-container").is(":visible")||$("#next-video-container").fadeIn():$("#next-video-container").is(":visible")&&$("#next-video-container").fadeOut();var h=this.prevVideoWidget?this.prevVideoWidget.currentView.model.get("id"):null;h&&this.prevHover?$("#prev-video-container").is(":visible")||$("#prev-video-container").fadeIn():$("#prev-video-container").is(":visible")&&$("#prev-video-container").fadeOut(),"PLAYING"==this.getLocalPlayerState()?this.showPlaying():"PAUSED"==this.getLocalPlayerState()?this.showPaused():"BUFFERING"==this.getLocalPlayerState()&&this.showLoader()}},onPlay:function(){if(this.showPlaying(),null!=AnimeApp.currentUser){var a=this;null==this.playbackPosition&&(this.playbackPosition=new PlaybackPosition({videoEntryId:this.model.get("videoEntry").id})),this.hbInterval=setInterval(function(){a.updatePosition()},HEARTBEAT_TIMEOUT)}},updatePosition:function(){if("IDLE"!=this.getLocalPlayerState()&&this.accurateDuration&&this.adShowing==ADVERT_STATE.NONE){var a=jwplayer().getPosition()/this.getDuration(),b=!1;a>=.85?(b=!0,this.completeTracked||(this.completeTracked=!0,Utils.trackEvent("Video Player","Video Complete",this.model.get("videoEntry").slug))):this.completeTracked=!1,this.savePlaybackPosition(jwplayer().getPosition(),b)}},onPause:function(){clearInterval(this.hbInterval),this.hbInterval=0,this.showPaused(),this.updatePosition()},onIdle:function(a){clearInterval(this.hbInterval),this.hbInterval=0,this.showLoader(),this.accurateDuration=!1,"PAUSED"==a.toUpperCase()&&jwplayer().pause()},onBuffer:function(){clearInterval(this.hbInterval),this.hbInterval=0,this.showLoader()},onComplete:function(){if(this.lastAdPlayedPlaybackPosition=-1,this.videoResumePositionAfterAd=-1,this.accurateDuration=!1,null!=AnimeApp.currentUser){this.playbackPosition.set({position:Math.round(jwplayer().getPosition()),complete:!0}),this.playbackPosition.unset("percentageWatched"),this.playbackPosition.unset("positionInMinutes"),this.playbackPosition.save(),this.videoEntryView&&this.videoEntryView.get("videoEntryId")==this.model.get("videoEntry").id||(this.videoEntryView=new VideoEntryView,this.videoEntryView.set({videoEntryId:this.model.get("videoEntry").id})),this.videoEntryView.save(),this.videoEntryView=null;var a=this.model.get("videoEntry");a.playbackPosition=this.playbackPosition.toJSON(),this.model.set("videoEntry",a),this.completeTracked||Utils.trackEvent("Video Player","Video Complete",this.model.get("videoEntry").slug)}clearInterval(this.hbInterval),this.isMobile||(this.playlistPosition++,this.playlistPosition<this.videos.size()?this.setupPlayer(this.showJWPlayerControls):this.onPlaylistComplete())},updateBuffer:function(a){1==this.accurateDuration&&(jwplayer().getBuffer()>=99?$(".video-buffer-bar").css("width","100%"):$(".video-buffer-bar").css("width",jwplayer().getBuffer()+"%")),"html5"==jwplayer().getRenderingMode()&&-1==jwplayer().getDuration()&&($(".video-buffering").hasClass("hidden")||(jwplayer().pause(!0),jwplayer().play(!0)))},nextVideo:function(a){this.playlistPosition<this.videos.length-1&&(this.prerollShown||!this.autoplay)&&(this.lastAdPlayedPlaybackPosition=-1,this.videoResumePositionAfterAd=-1,this.accurateDuration=!1,this.playlistPosition++,this.isMobile?this.loadVideo(this.playlistPosition,!0,!0,!0):this.setupPlayer(this.showJWPlayerControls),$("#next-video-container").is(":visible")&&$("#next-video-container").fadeOut(),Utils.trackEvent("Video Player","Next Button Clicked",this.model.get("videoEntry").slug))},prevVideo:function(a){this.playlistPosition>=1&&(this.prerollShown||!this.autoplay)&&(this.lastAdPlayedPlaybackPosition=-1,this.videoResumePositionAfterAd=-1,this.accurateDuration=!1,this.playlistPosition>=this.videos.length&&(this.playlistPosition=this.videos.length-1),this.playlistPosition--,this.isMobile?this.loadVideo(this.playlistPosition,!0,!0,!0):this.setupPlayer(this.showJWPlayerControls),$("#prev-video-container").is(":visible")&&$("#prev-video-container").fadeOut(),Utils.trackEvent("Video Player","Previous Button Clicked",this.model.get("videoEntry").slug))},checkPlaylistControls:function(){this.playlistPosition>=this.videos.length-1?$(".video-next").hide():$(".video-next").show(),this.playlistPosition<=0||this.videos.length<=1?$(".video-prev").hide():$(".video-prev").show(),1==jwplayer().getMute()?$(".video-volume").hasClass("mute")||$(".video-volume").addClass("mute"):$(".video-volume").removeClass("mute")},onControlBarClick:function(a){this.stopPropagation(a);var b=this.getClickPositionVideoPercentage(a);this.updateSeekBar(b);var c=this.getDuration()*b/100;this.seekToTime(c),$(".video-play").removeClass("paused")},onVolumeClick:function(a){this.stopPropagation(a);var b=$(a.target).offset(),c=($(a.target).position().left,a.pageX-b.left),d=c/$(".potential-volume").width()*100;this.setVolume(d)},onVolumeEnter:function(a){$(".video-volume-control-bar").removeClass("hidden")},bodyWatcher:function(a){if(!this.currentMouse||this.currentMouse.x!=a.pageX||this.currentMouse.y!=a.pageY)if(this.currentMouse={x:a.pageX,y:a.pageY},this.showControls(),this.accurateDuration){$(".seek-tool-tip").show(),$(".seek-tool-tip").css("left",a.pageX-$(".seek-tool-tip").width()/2);var b=Utils.secondsToTime(a.pageX/$(window).width()*this.videoDuration);$(".seek-tool-tip .seek-time").replaceWith('<div class="seek-time">'+b+"</div>")}else $(".seek-tool-tip").hide()},showControls:function(a){if(!this.controlsDisabled||a){var b,c=$(this),d=c.data("timer"),e=c.data("buffer");if(e)c.data("buffer",!1);else{d&&clearTimeout(d),$(".must-show").show(),this.checkPlaylistControls(),$(".video-overlayer").removeClass("overlayer-hidden");var f=this;b=setTimeout(function(){f.hideControls()},2e3)}c.data("timer",b),$(this.el).find(".has-tooltip").tooltip({container:".video-data"})}},hideControls:function(){$(".video-overlayer").addClass("overlayer-hidden"),$(".must-show").delay(550).hide(),$(".video-next").delay(550).hide(),$(".video-prev").delay(550).hide(),$(".video-volume").removeClass("clicked"),$(".video-volume").removeClass("changing-volume"),$(".video-volume-control-bar").addClass("hidden"),$(this).data("buffer",!0),this.nextHover=!1,this.prevHover=!1,$(this.el).find(".has-tooltip").tooltip("destroy")},hideControlsForAdvert:function(){$(".video-overlayer").addClass("advert"),$(".video-buffering").addClass("hidden"),$(this.el).find(".has-tooltip").tooltip("destroy")},showControlsAfterAdvert:function(){$(".video-overlayer").removeClass("advert")},updatePlayerPosition:function(){this.playbackPosition.get("complete")&&(this.playbackPosition.set("complete",!1),this.playbackPosition.set("position",0))},showSubscriptionModal:function(a){return this.doPause(),Utils.showSubscribeModal(),!1},switchToDubbed:function(a){if(this.permissions.canWatchDubbed){var b="/"+this.baseUrl+this.model.get("videoEntry").slug+"/dubbed";window.location.href=b}else this.doPause(),Utils.showSubscribeModal()},switchToSubbed:function(a){if(this.permissions.canWatchSubbed){var b="/"+this.baseUrl+this.model.get("videoEntry").slug+"/subtitles";window.location.href=b}else this.doPause(),Utils.showSubscribeModal()},doPause:function(a){var b=this.getLocalPlayerState();("PLAYING"==b||"BUFFERING"==b)&&(jwplayer().pause(!0),this.showPaused(),Utils.trackEvent("Video Player","Play State","Paused"))},handleEscape:function(){},doChromecast:function(a){},getLocalPlayerState:function(){return jwplayer().getState().toUpperCase()},pauseLocalPlayer:function(){
jwplayer().stop()},showLoader:function(){$(".video-buffering").removeClass("hidden"),$(".video-play").addClass("buffering")},showPlaying:function(){$(".video-play").removeClass("paused"),$(".video-play").removeClass("buffering"),$(".video-buffering").addClass("hidden")},showPaused:function(){$(".video-play").addClass("paused"),$(".video-play").removeClass("buffering"),$(".video-buffering").addClass("hidden")},getClickPositionVideoPercentage:function(a){var b=$(a.target).offset(),c=a.pageX-b.left;return c/$(window).width()*100},updateAipBars:function(a){$(".video-aip-bar").remove();var b=$(".video-control-bar");$.each(this.midRollTimecodes,function(c,d){b.append($('<div class="video-aip-bar" style="left: '+d/a*100+'%;"></div>'))})},updateSeekBar:function(a){$(".video-progress-bar").css("width",a+"%")},updateClockPosition:function(a){$(".video-position").html(Utils.secondsToTime(a))},setClockDuration:function(a){$(".video-duration").html(Utils.secondsToTime(a)),this.videoDuration=a},seekToTime:function(a){this.lastAdPlayedPlaybackPosition=Math.min(this.currentPosition>0?this.currentPosition:a,a),jwplayer().seek(a)},savePlaybackPosition:function(a,b){this.playbackPosition.set({position:Math.round(a),complete:b}),this.playbackPosition.unset("percentageWatched"),this.playbackPosition.unset("positionInMinutes"),this.playbackPosition.save(),b&&(this.videoEntryView&&this.videoEntryView.get("videoEntryId")==this.model.get("videoEntry").id||(this.videoEntryView=new VideoEntryView,this.videoEntryView.set({videoEntryId:this.model.get("videoEntry").id})),this.videoEntryView.save());var c=this.model.get("videoEntry");c.playbackPosition=this.playbackPosition.toJSON(),this.model.set("videoEntry",c)},localPlayerIsMute:function(){return jwplayer().getMute()},localPlayerVolume:function(){return jwplayer().getVolume()},playItemAtPosition:function(){this.isMobile?this.loadVideo(this.playlistPosition):(this.setupPlayer(this.showJWPlayerControls),jwplayer().play())},stopPropagation:function(a){var b=a||window.event;b&&(b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)},getTimecodeSeconds:function(a){var b=0;if(null!=a&&a.indexOf(":")>-1){var c=a.split(":");3==c.length&&(b+=60*Number(c[0])*60,b+=60*Number(c[1]),b+=Number(c[2]))}return b}}),VideoController=Marionette.Controller.extend({view:function(a,b,c,d,e,f,g){var h=new VideoPlayerView({videos:a,playlistPosition:b,baseUrl:c,returnUrl:d,updateUrl:e,ads:f,autoplay:g});AnimeApp.videoPlayer.show(h)}}),PlaybackPosition=CoreModel.extend({url:"/api/playbackpositions",initialize:function(a){}}),PlaylistListItemView=Backbone.Marionette.Layout.extend({template:"playlistListItem",tagName:"li",className:"has-handle",permissions:{},regions:{smartPlaylistWidget:"#add-smart-playlist-container",chromeCastWidget:"#chrome-cast-container"},events:{"click .action-episode-synopsis":"showEpisodeSynopsisModal","click .action-mark-watched":"toggleWatched","click .button-watch-subbed":"watchSubbedVideo","click .button-watch-dubbed":"watchDubbedVideo","click .action-play-episode":"watchVideo","click .options a":"hideDropdown"},playlistVideoEntry:null,popover:!1,initialize:function(a){this.$el.data("id",this.model.get("id")),$(this.el).addClass("has-handle"),a.first&&this.model.set("first",!0),a.subtitles&&this.model.set("subtitles",a.subtitles)},serializeData:function(){return{playlistVideoEntry:this.model.toJSON(),permissions:this.permissions}},className:function(){var a=new VideoEntry(this.model.get("videoEntry"));return a.initCalculatedFields(),this.model.set("videoEntry",a.toJSON()),this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.get("videoEntry")):{},this.permissions.canWatch?this.model.get("videoEntry").playbackPosition&&1==this.model.get("videoEntry").playbackPosition.complete?"watched":null:"premium"},onShow:function(){var a,b=this,c=this.model.get("id");a=new PlaylistVideoEntry(this.model.get("smartPlaylistVideoEntry")?this.model.get("smartPlaylistVideoEntry"):{videoEntryId:c,following:!1}),this.model.set("episodeName",this.model.get("videoEntry").name);var d=new SmartPlaylistWidget({model:this.model,parent:b,click:this.hideDropdown,permissions:this.permissions});this.smartPlaylistWidget.show(d);var e=new ChromeCastWidget({videoEntry:new VideoEntry(b.model.get("videoEntry")),url:"/player/playlist/"+this.model.get("videoEntry").slug,click:this.hideDropdown});this.chromeCastWidget.show(e)},removedFromPlaylist:function(){AnimeApp.vent.trigger("videoEntry:removedFromPlaylist",this.model)},showEpisodeSynopsisModal:function(a){var b=new EpisodeSynopsisModalView({model:new VideoEntry(this.model.get("videoEntry")),permissions:this.permissions});return AnimeApp.episodeModal.show(b),$("#episode-synopsis-modal").modal("show"),!1},toggleWatched:function(a){var b;b=this.model.get("videoEntry").playbackPosition?new PlaybackPosition(this.model.get("videoEntry").playbackPosition):new PlaybackPosition;var c=$(a.target).closest("a.action-mark-watched").hasClass("watched");c&&(b.set({videoEntryId:this.model.get("videoEntry").id,complete:c,position:0}),b.unset("percentageWatched"),b.unset("positionInMinutes"));var d=this,e=function(){d.model.get("videoEntry").playbackPosition=c?b.toJSON():null,c?d.$el.addClass("watched"):d.$el.removeClass("watched"),d.render();var a=new SmartPlaylistWidget({model:d.model,parent:d,click:d.hideDropdown,permissions:this.permissions});d.smartPlaylistWidget.show(a),d.chromeCastWidget.show(new ChromeCastWidget({videoEntry:new VideoEntry(d.model.get("videoEntry")),url:"/player/playlist/"+d.model.get("videoEntry").slug,click:d.hideDropdown})),AnimeApp.vent.trigger("playlistListing:playlistUpdated",this)};try{$.when(c?b.save():b.destroy()).done(function(){e()})}catch(f){e()}if(c){var g=d.model.get("videoEntry").slug;Utils.trackEvent("Episodes","Episode Marked Watched",g)}else{var g=d.model.get("videoEntry").slug;Utils.trackEvent("Episodes","Episode Marked Unwatched",g)}return!1},watchSubbedVideo:function(a){var b=!1;if(this.model.get("videoEntry").hasSubbedVideo)if(this.permissions.canWatchSubbed){var c=this.model.get("videoEntry").slug;Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/playlist/"+this.model.get("videoEntry").slug+"/subtitles"}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1},watchDubbedVideo:function(a){var b=!1;if(this.model.get("videoEntry.").hasDubbedVideo)if(this.permissions.canWatchDubbed){var c=this.model.get("videoEntry").slug;Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/playlist/"+this.model.get("videoEntry").slug+"/dubbed"}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1},watchVideo:function(a){var b=!1;if(this.permissions.canWatch){var c=this.model.get("videoEntry").slug;Utils.trackEvent("Episodes","Episode Watch Clicked",c),b="/player/playlist/"+this.model.get("videoEntry").slug}else Utils.showSubscribeModal();return b&&(window.location.href=b),!1},hideDropdown:function(a){a&&$(a.target).closest(".options").removeClass("open")}}),EmptyWatchedPlaylistView=Backbone.Marionette.ItemView.extend({template:"emptyWatchedPlaylist",className:"custom-message",tagName:"li"}),EmptyPlaylistView=Backbone.Marionette.ItemView.extend({template:"emptyPlaylist",className:"custom-message",tagName:"li",initialize:function(a){}}),PlaylistListingView=Backbone.Marionette.CollectionView.extend({itemView:PlaylistListItemView,className:"episode-listing",tagName:"ul",initialize:function(a){a.myListing&&(AnimeApp.vent.on("videoEntry:removedFromPlaylist",_.bind(this.removedFromPlaylist,this)),AnimeApp.vent.on("playlistListing:playlistUpdated",_.bind(this.onDrop,this)),AnimeApp.vent.on("playlistListing:clearPlaylist",_.bind(this.clearQueue,this))),a.watched&&(this.watched=a.watched),a.infiniteScroll&&new InfiniteScroll(this),this.subtitles=a.subtitles},itemViewOptions:function(a,b){return{first:0==b,subtitles:this.subtitles}},getEmptyView:function(){return this.watched?EmptyWatchedPlaylistView:EmptyPlaylistView},onShow:function(){this.createSortable()},createSortable:function(){$(this.el).sortable({handle:".handle"}).bind("sortupdate",_.bind(this.onDrop,this))},onDrop:function(){$(this.el).sortable().unbind("sortupdate"),$(this.el).sortable("destroy");var a=this,b=new PlaylistVideoEntryCollection;$(this.el).children().each(function(c){var d=$(this).data("id"),e=a.collection.get(d);b.add(e,{silent:!0});var f=a.children.findByModel(e);0==c?e.set("first",!0):e.unset("first"),f.render(),f.onShow()}),this.collection=b,this.createSortable();var c=[];this.collection.each(function(a,b){c.push({id:a.get("id"),sequence:b})}),$.ajax({type:"POST",url:"/api/playlistvideoentries/reorder",data:JSON.stringify({orders:c}),dataType:"json",contentType:"application/json; charset=utf-8"})},removedFromPlaylist:function(a){if(this.collection.remove(a),this.collection.size()>0){var a=this.collection.at(0);if(!a.get("first")){a.set("first",!0);var b=this.children.findByModel(a);b.render(),b.onShow(),$("#watch-upcoming-button").attr("href","player/playlist/"+a.get("slug"))}}},onLoadedMoreContent:function(){this.createSortable()},removeChildView:function(a){if(a){this.stopListening(a);var b=this;$(a.el).slideUp("slow",function(){a.close?a.close():a.remove&&a.remove(),b.children.remove(a)})}this.triggerMethod("item:removed",a)},clearQueue:function(a){var b=this.collection;$.get("/api/myqueue/clear",function(){b.reset(),$(".actions.no-horizontal-margin").slideUp(),Utils.notify("success",Messages("js.smartplaylistwidget.cleared",self.model.get("name")))})}}),EpisodeQueueItemView=Backbone.Marionette.Layout.extend({template:"playlistListItem",tagName:"li",regions:{chromeCastWidget:"#chrome-cast-container"},events:{"click .action-episode-synopsis":"showEpisodeSynopsisModal","click .action-mark-watched":"toggleWatched","click .button-watch-subbed":"watchSubbedVideo","click .button-watch-dubbed":"watchDubbedVideo","click .action-play-episode":"watchVideo","click .options a":"hideDropdown"},popover:!1,playlistVideoEntry:null,initialize:function(a){this.playlistVideoEntry=new PlaylistVideoEntry,this.playlistVideoEntry.set({videoEntry:this.model.toJSON(),noHandle:!0}),this.$el.data("id","episode-queue-item-"+this.model.get("id")),a.first&&this.playlistVideoEntry.set("first",!0),a.subtitles&&this.model.set("subtitles",a.subtitles)},serializeData:function(){return{playlistVideoEntry:this.playlistVideoEntry.toJSON(),permissions:this.permissions}},className:function(){return this.permissions=null!=AnimeApp.currentUser?AnimeApp.currentUser.permissionsForVideoEntry(this.model.toJSON()):{},this.permissions.canWatch?this.model.get("playbackPosition")&&1==this.model.get("playbackPosition").complete?"watched":null:"premium"},onShow:function(){var a=new ChromeCastWidget({videoEntry:this.model,url:"/player/"+this.model.get("slug"),click:this.hideDropdown});this.chromeCastWidget.show(a)},showEpisodeSynopsisModal:function(a){var b=new EpisodeSynopsisModalView({model:this.model});return AnimeApp.episodeModal.show(b),$("#episode-synopsis-modal").modal("show"),!1},toggleWatched:function(a){var b;b=this.model.get("playbackPosition")?new PlaybackPosition(this.model.get("playbackPosition")):new PlaybackPosition;var c=$(a.target).closest("a.action-mark-watched").hasClass("watched");c&&(b.set({videoEntryId:this.model.get("id"),complete:c,position:0}),b.unset("percentageWatched"),b.unset("positionInMinutes"));var d=this,e=function(){d.model.set("playbackPosition",c?b.toJSON():null),d.playlistVideoEntry.set("videoEntry",d.model.toJSON()),$.when(d.model.collection.fetch({data:{userId:AnimeApp.currentUser.get("id")}})).done(function(){$(window).scroll()})};try{$.when(c?b.save():b.destroy()).done(function(){e()})}catch(f){e()}if(c){var g=this.model.get("slug");Utils.trackEvent("Episodes","Episode Marked Watched",g)}else{var g=this.model.get("slug");Utils.trackEvent("Episodes","Episode Marked Unwatched",g)}return!1},watchSubbedVideo:function(a){if(this.permissions.canWatchSubbed){var b=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",b);var c="/player/"+this.model.get("slug")+"/subtitles";window.location.href=c}else Utils.showSubscribeModal();return!1},watchDubbedVideo:function(a){if(this.permissions.canWatchDubbed){var b=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",b);var c="/player/"+this.model.get("slug")+"/dubbed";window.location.href=c}else Utils.showSubscribeModal();return!1},watchVideo:function(a){if(this.permissions.canWatch){var b=this.model.get("slug");Utils.trackEvent("Episodes","Episode Watch Clicked",b);var c="/player/"+this.model.get("slug");window.location.href=c}else Utils.showSubscribeModal();return!1},hideDropdown:function(a){a&&$(a.target).closest(".options").removeClass("open")}}),EpisodeQueueCollectionView=Backbone.Marionette.CollectionView.extend({itemView:EpisodeQueueItemView,className:"episode-listing",tagName:"ul",initialize:function(a){a.infiniteScroll&&new InfiniteScroll(this),this.subtitles=a.subtitles},itemViewOptions:function(a,b){return{first:0==b,subtitles:this.subtitles}},getEmptyView:function(){return EmptyWatchedPlaylistView}}),PlaylistController=Marionette.Controller.extend({smartQueuePage:function(a,b,c){var d=new PlaylistListingView({collection:a,myListing:!0,subtitles:c,infiniteScroll:!0});$(".clear-queue").click(function(a){AnimeApp.vent.trigger("playlistListing:clearPlaylist",a)}),AnimeApp.smartQueue.show(d);var e=new EpisodeQueueCollectionView({collection:b,subtitles:c,infiniteScroll:!0});AnimeApp.recentEpisodesQueue.show(e)}}),EpisodeController=Marionette.Controller.extend({allEpisodesPage:function(a){var b=new EpisodeCardCollectionView({collection:a,infiniteScroll:!0});AnimeApp.allEpisodes.show(b)}}),ChromebarView=Backbone.Marionette.ItemView.extend({template:"chromebar",deviceState:DEVICE_STATE.IDLE,currentMedia:null,className:"cast-bar",castPlayerState:PLAYER_STATE.IDLE,playbackPosition:null,positionTimer:null,events:{"click .action-toggle-cast":"toggleCastState","click .action-end-cast":"endCast"},initialize:function(a){chrome.cast&&chrome.cast.isAvailable||setTimeout(_.bind(this.initializeCastApi,this),1e3)},initializeCastApi:function(){if(!chrome.cast||!chrome.cast.isAvailable)return void setTimeout(_.bind(this.initializeCastApi,this),2e3);var a=new chrome.cast.SessionRequest(STYLED_RECEIVER_APP_ID),b=new chrome.cast.ApiConfig(a,_.bind(this.sessionListener,this),_.bind(this.receiverListener,this));chrome.cast.initialize(b,_.bind(this.onInitSuccess,this),_.bind(this.onChromecastError,this))},onInitSuccess:function(){Utils.trackEvent("Casting","Session Started","User"),this.deviceState=DEVICE_STATE.ACTIVE},onChromecastError:function(a){this.deviceState=DEVICE_STATE.ERROR},sessionListener:function(a){ChromebarView.cast.session=a,this.session=a,this.deviceState=DEVICE_STATE.ACTIVE,this.session.media[0]&&this.loadMediaFromSession(this.session.media[0]);var b=this,c=function(a){b.sessionUpdateListener.call(b,a)};this.session.addUpdateListener(c),AnimeApp.vent.trigger("chromeCast:session",this.session)},sessionUpdateListener:function(a){a||this.onStopSessionSuccess(),AnimeApp.vent.trigger("chromeCast:sessionUpdate",this.session)},receiverListener:function(a){ChromebarView.cast.castAvailable=a===chrome.cast.ReceiverAvailability.AVAILABLE,AnimeApp.vent.trigger("chromeCast:receiverAvailability",ChromebarView.cast.castAvailable)},loadMediaFromSession:function(a){this.currentMediaSession=a;var b="";a.media.metadata.images.length>0&&(b=a.media.metadata.images[1].url),this.castPlayerState=a.playerState;var c=this.castPlayerState==PLAYER_STATE.PLAYING;this.model=new Backbone.Model({seriesName:a.media.metadata.seriesTitle,thumbnail:b,episodeNumber:a.media.metadata.episode,title:a.media.metadata.title,receiverName:this.session.receiver.friendlyName,isPlaying:c,url:a.media.customData.url,videoEntryId:a.media.customData.videoEntryId}),this.createPositionTimer(),AnimeApp.chromebar.show(this)},createPositionTimer:function(){clearInterval(this.positionTimer),this.positionTimer=0,this.positionTimer=setInterval(_.bind(this.updatePosition,this),HEARTBEAT_TIMEOUT)},updatePosition:function(){if(this.castPlayerState==PLAYER_STATE.PLAYING){var a=this.model.get("videoEntryId"),b=this.currentMediaSession.getEstimatedTime(),c=this.currentMediaSession.media.duration,d=b/c,e=!1;d>=.85&&(e=!0),null==this.playbackPosition&&(this.playbackPosition=new PlaybackPosition),this.playbackPosition.set({videoEntryId:a,position:Math.round(b),complete:e}),this.playbackPosition.save(),e&&(this.videoEntryView||(this.videoEntryView=new VideoEntryView,this.videoEntryView.set({videoEntryId:this.model.get("videoEntryId")})),this.videoEntryView.save())}},toggleCastState:function(a){return this.castPlayerState==PLAYER_STATE.PLAYING?(this.castPlayerState=PLAYER_STATE.PAUSED,this.currentMediaSession.pause(null,_.bind(this.mediaCommandSuccessCallback,this),_.bind(this.errorHandler,this))):(this.currentMediaSession.play(null,_.bind(this.mediaCommandSuccessCallback,this),_.bind(this.errorHandler,this)),this.currentMediaSession.addUpdateListener(_.bind(this.mediaStatusUpdateHandler,this)),this.castPlayerState=PLAYER_STATE.PLAYING),!1},mediaCommandSuccessCallback:function(){this.castPlayerState==PLAYER_STATE.PLAYING?this.createPositionTimer():(clearInterval(this.positionTimer),this.positionTimer=0),this.currentMediaSession&&(this.model.set("isPlaying",this.castPlayerState==PLAYER_STATE.PLAYING),this.render())},endCast:function(a){return this.session.stop(function(){},_.bind(this.errorHandler,this)),!1},onStopSessionSuccess:function(){clearInterval(this.positionTimer),this.deviceState=DEVICE_STATE.IDLE,this.castPlayerState=PLAYER_STATE.IDLE,ChromebarView.cast.session=null,this.session=null,this.model=null,this.currentMediaSession=null,AnimeApp.chromebar.reset(),AnimeApp.vent.trigger("chromeCast:endSession",this)},errorHandler:function(a){console.log(a)},mediaStatusUpdateHandler:function(a){a||(this.currentMediaTime=0,this.castPlayerState=PLAYER_STATE.IDLE)},onClose:function(){clearInterval(this.positionTimer)}},{cast:{session:null,castAvailable:!1}}),ChromebarController=Marionette.Controller.extend({showBar:function(){if("undefined"!=typeof chrome&&0==$("#video-player-container").length&&$("#chromebar-container").length>0){AnimeApp.addRegions({chromebar:"#chromebar-container"}),console.log("initializing chromebar");new ChromebarView}}});